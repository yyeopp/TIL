# 프로세스와 스레드

---

## 멀티태스킹과 멀티프로세싱

### 프로그램 실행

프로그램의 실행이라는 건 결국 프로그램을 구성하는 코드를 **순서대로 CPU에서 연산**하는 일이다.

CPU의 **코어**가 하나밖에 없다면 물리적으로 한 번에 하나의 프로그램 코드만 연산 가능할 것이고,

어떠한 처리가 없다는 가정 하에 **한 번에 하나의 프로그램만 실행** 가능하여 사용자가 상당한 불편을 겪게 된다.

### 멀티태스킹

CPU가 한 번에 하나의 프로그램 코드만 연산하는 것은 바꿀 수 없는 전제이다.

컴퓨터의 **멀티태스킹**은, 마치 애니메이션과 같이 **매우 빠르게 두 프로그램의 코드를 번갈아 수행**한 결과이다.

- 사람이 느낄 때, 두 프로그램이 동시에 실행되는 것처럼 느끼기에 충분할 정도로 빠르게 번갈아 수행하면 된다.

- 대략 0.01초 (10ms) 정도씩 번갈아 수행하고 있다.

이렇게 프로그램의 실행 **시간**을 분할해서 동시에 실행되는 것처럼 하는 기법은 **시분할**(Time sharing) 기법이라고 한다.

이를 통해 단일 CPU 코어로도 **여러 프로그램을 동시에 실행**하는 것처럼 **느낄 수 있다**.

그리고 이러한 컴퓨터의 처리 능력을 **멀티태스킹**이라고 한다.

#### 스케줄링

CPU에 어떤 프로그램이 얼마만큼 실행될지는 **운영체제**가 결정하는데, 이를 스케줄링이라고 한다.

단순 **시간** 뿐만이 아니라, **다양한 우선순위와 최적화** 기법이 적용되고 있다.

자세한 내용은 운영체제 이론을 따로 공부

### 멀티프로세싱

지금까지는 **싱글 코어**가 전제였고, CPU 코어는 **둘 이상**으로 구성될 수 있다.

- 과거에는 하나의 CPU에 하나의 코어만 존재했는데,

- 지금 CPU는 기본적으로 두 개 이상이다.

이렇게 되면, 2개 이상의 프로그램을 동시에 실행시키는 것이 **물리적으로 가능**해진다.

컴퓨터에서 둘 이상의 프로세서 (CPU 코어)를 사용하여 여러 작업을 **동시에 처리**하는 기술을 **멀티프로세싱**이라고 한다.

- 당연히, 싱글코어보다 동시에 더 많은 작업을 처리할 수 있다.

### 멀티프로세싱과 멀티태스킹

멀티프로세싱은 **하드웨어** 장비의 관점이고

멀티태스킹은 **운영체제 소프트웨어**의 관점이다.

---

## 프로세스와 스레드

### 프로세스

운영체제 안에서 **실행 중인 프로그램**을 프로세스라고 한다.

다른 말로, 프로세스는 실행 중인 프로그램의 **인스턴스**이다.

- 자바의 클래스가 프로그램, 실행 중인 인스턴스가 프로세스

각 프로세스는 **독립적인 메모리 공간**이 부여되며, 운영체제에서도 별도의 작업 단위로 분리하여 관리된다.

프로세스 간에는 서로의 메모리에 직접 접근이 불가하다. 특정 프로세스에 심각한 문제가 발생하여 강제 종료될 때, 다른 프로세스에는 영향을 주지 않는다.

#### 프로세스의 메모리 구성

- **코드** 섹션 : 실행할 프로그램의 코드가 저장되는 부분

- **데이터** 섹션 : 전역 변수 및 정적 변수가 저장되는 부분

- **힙**(Heap) : 동적으로 할당되는 메모리 영역

- **스택**(Stack) : 메서드(함수) 호출 시 생성되는 지역 변수와 반환 주소가 저장되는 영역
  
  - **스레드에 포함**

### 스레드 (Thread)

프로세스는 **하나 이상의 스레드를 반드시 포함**한다.

한 프로세스 내에 여러 스레드가 존재할 수 있고,

프로세스가 제공하는 **동일한 메모리 공간**을 공유한다.

프로세스보다 단순하므로, **생성 및 관리**가 상대적으로 단순하고 가볍다.

#### 메모리 구성

- **공유 메모리** : 같은 프로세스의 코드, 데이터, 힙을 모든 스레드가 공유한다.

- **개별 스택** : 각 스레드는 자신의 스택을 가지고 있다. 다른 스레드의 스택을 침범할 수 없다.

#### 프로그램이 실행된다는 것은?

프로그램을 실행하고자 하면,

운영체제는 우선 디스크에 존재하는 프로그램을 메모리로 불러오면서 프로세스를 만든다.

그리고 프로세스 안에 있는 **코드가 한 줄씩 실행**되는 것이 **프로그램 실행**의 실체이다.

프로세스의 코드를 **실행하는 흐름**을 스레드라고 한다.

- 실(thread)로 코드를 위에서 아래로 하나씩 꿰면서 내려가는 것을 상상하면 된다.

즉, 스레드는 프로세스 내에서 실행되는 **작업의 단위**라고도 볼 수 있다.

- **단일 스레드** : 한 프로세스 내에 하나의 스레드만 존재

- **멀티 스레드** : 한 프로세스 내에 여러 스레드가 존재

정리하면, 다음과 같다.

- **프로세스는 실행 환경과 자원을 제공하는 컨테이너**

- **스레드는 CPU를 사용해서 코드를 하나하나 실행**

#### 멀티 스레드가 필요한 이유

**하나의 프로그램 내에서도 여러 작업이 동시에 이루어져야 하기 때문**

---

## 스레드와 스케줄링

결과적으로, 하나의 CPU 코어가 **멀티태스킹**을 달성하는 것의 실체는 **여러 프로세스의 여러 스레드**를 번갈아가며 실행시키는 것이다.

### 단일 코어 스케줄링

운영체제는 내부에 **스케줄링 큐**를 가지고 있고, 각각의 스레드는 **스케줄링 큐에서 대기**한다.

운영체제는 큐에서 스레드를 하나씩 꺼내서 CPU를 통해 실행하고, 정해진 실행 시간이 지나면 다시 큐에 집어넣는 작업을 반복한다.

### 멀티 코어 스케줄링

스케줄링 큐를 공유하는 여러 개의 코어가 존재할 뿐이다.

기본적인 원리는 동일하다.

---

## 컨텍스트 스위칭

### 컴퓨터의 멀티태스킹

CPU가 여러 스레드를 번갈아가면서 수행하기 위해서는, **이전에 실행했던 스레드를 어디까지 수행했었는지** 위치를 정확하게 알고 있어야 하며, **계산 중이던 변수가 있다면 다시 불러와야**한다.

즉, 스레드가 멈추는 시점에 사용하던 변수를 포함한 여러 메타데이터를 **메모리에 저장**해둬야 하고, 다시 실행할 때 이 값들을 로딩해와야 한다.

이런 과정을 **컨텍스트 스위칭**이라고 한다.

- 당연히, 컨텍스트 스위칭 과정은 **비용**을 수반한다.

**멀티스레드는 대부분 효율적이지만, 컨텍스트 스위칭 과정이 필요하므로 항상 효율적인 것은 아니다.**

### 실무 일반론

**스레드의 숫자를 CPU의 숫자에 맞추는 게 이상적**이다.

- CPU를 100% 활용할 가능성이 크고,

- 컨텍스트 스위칭 비용도 자주 발생하기 어려운 환경이 된다.

정확히는 CPU 코어 수 **+ 1개** 정도로 맞추는 게 일반적이다.

#### CPU 바운드 작업 vs I/O 바운드 작업

- **CPU 바운드** 작업
  
  - CPU의 연산 능력을 많이 요구하는 작업을 의미
  
  - 계산, 데이터 처리, 알고리즘 실행 등

- **I/O 바운드** 작업
  
  - 디스크, 네트워크, 파일 시스템 등 입출력 작업을 많이 요구하는 작업
  
  - 이러한 작업은 I/O 작업 과정의 **대기 시간**이 많이 발생하여, CPU는 오히려 **유휴 상태**에 있는 경우가 많다.
  
  - DB 쿼리 처리, 파일 입출력, 네트워크 통신 등

#### 웹 애플리케이션 서버

일반적인 웹 애플리케이션 서버는 **I/O 바운드 작업** 위주이다.

- 즉, 대부분의 스레드는 CPU를 사용하지 않고 **대기**한다.

단순하게 따졌을 때 **한 명의 사용자는 하나의 스레드**에 물려있다고 볼 수 있는데,

컨텍스트 스위칭을 우려하여 스레드 개수를 적게 산정할 시 **동시 사용자 수는 적으면서 막상 CPU는 놀고 있는** 상태가 될 수 있다.

즉, 실무에서는 **성능 테스트**를 통해 **최적의 스레드 숫자를 찾는 것이 이상적**이다.

#### 이상적인 스레드 숫자 산정

- CPU 바운드 작업의 경우 : CPU 코어 수 + 1개

- I/O 바운드 작업 : CPU 코어 수보다 많은 스레드를 생성해야 함. CPU를 **최대한 사용할 수 있는 숫자까지 생성**
  
  - 성능 테스트를 통해 산정할 필요
  
  - 너무 많은 스레드를 생성하여 컨텍스트 스위칭 비용이 증가하는 것은 유의


