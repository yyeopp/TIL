# 동기화 - synchronized

---

## Intro

멀티스레드에서 주의할 점은, **같은 자원에 여러 스레드가 동시에 접근할 때 발생하는 동시성 문제**이다.

- 여러 스레드가 접근하는 자원을 **공유 자원**이라 하며

- 대표적인 공유 자원은 인스턴스의 **필드**값이다.

멀티스레드 환경에서는 공유 자원에 대한 접근을 적절히 **동기화**하여 동시성 문제를 방지해야 한다.

---

## 임계 영역

공유 자원에 대한 동시성 문제의 **근본 원인**은 공유 자원을 **여러 단계로 나누어 사용**하기 때문이다.

> 간단한 입출금 예제를 상정한다.

출금 로직은 **검증**과 **출금** 2단계로 이루어지는데, 멀티스레드를 상정하지 않은 로직은 **검증 단계에서 확인한 금액이 출금 단계까지 동일하게 유지된다는 가정**을 깔고 있다.

즉, 그 중간 단계에서 **다른 스레드가** 잔액을 변경할 때 예기치 못한 상황이 발생하게 된다.

#### 공유 자원

**잔액**은 대표적으로 여러 스레드가 함께 사용하는 공유 자원이다.

출금 로직을 수행하는 중간에 다른 스레드에서 얼마든지 해당 값을 변경할 수 있고, 이는 대표적인 동시성 문제를 발생시킨다.

### 임계 영역

이를 해결하는 대표적인 방법은 **출금 메서드** 자체를 **한 번에 하나의 스레드만 실행 가능하도록** 통제하는 방법이다.

- 그러면 검증 단계의 잔액이 출금 단계까지 **무조건** 동일한 값으로 유지될 수 있고,

- 동시성 문제가 해소될 수 있다.

**임계 영역**은, 여러 스레드가 동시에 접근할 시 데이터 불일치 등 예상치 못한 동작이 발생할 수 있는 **위험하고 중요한 코드 부분**을 뜻한다.

- 여러 스레드가 동시에 공유 자원에 접근 혹은 수정하는 부분이 대표적이다.

- 입출금 예시에서 **출금 메서드**가 이에 해당한다고 보면 된다.

임계 영역엔 **한 번에 하나의 스레드만 접근할 수 있도록** 안전하게 보호해야 한다.

자바에서는 `synchronized` 키워드를 이용하여 간단하게 임계 영역을 보호하고 있다.

---

## synchronized 메서드

자바의 `synchronized` 키워드를 사용하면 **간편하게 임계 영역을 보호**할 수 있다.

### synchronized 분석

**모든 객체(인스턴스)는 내부에 자신만의 락(lock)을 가지고 있다**.

- 이를 **모니터 락**이라고 하며,

- 객체 내부에 항상 존재하고 개발자가 확인하기는 어렵다.

스레드가 `synchronized` 키워드가 있는 메서드가 진입하려면, **반드시 해당 인스턴스의 락을 가져와야 하는** 원리이다.

서로 다른 스레드가 `synchronized` 메서드에 접근할 때, 하나의 스레드가 **락 획득**에 성공하면 다른 스레드는 **BLOCKED** 상태에서 **무한정 대기**하게 된다.

- 락을 다시 획득하기 전까지 계속 대기한다. 

- CPU 실행 스케줄링에 아예 들어가지 않는다.

#### 락을 획득하는 순서는 보장되지 않는다.

수많은 스레드가 동시에 synchronized 메서드를 호출한다고 했을 때, **그 중 어떤 스레드가 락을 획득하는지, 락을 반납했을 때 어떤 스레드가 그 다음으로 가져가는지** 등은 정해진 바가 없다.

- **순서를 보장하지 않는다.**

- 환경에 따라 달라질 것.

#### volatile과의 관계

`synchronized` 안에서 접근하는 변수의 경우, 성격 상 **메모리 가시성** 문제는 자동으로 해소된다.

- `volatile` 을 굳이 사용하지 않아도 된다.

---

## synchronized 코드 블럭

`synchronized`의 가장 큰 장점이자 단점은 **한 번에 하나의 스레드만 실행할 수 있다는 점**이다.

- 전체로 봤을 때 **성능에 치명적**이다.

그래서 `synchronized` 적용이 **반드시 필요한 구간에만 한정하여 사용**해야 한다.

### 코드 블럭 사용

메서드에 선언된 `synchronized`를 제거하고, 대신 **진짜 임계영역 코드**에 대해서

`synchronized(this) { // 임계영역 로직 }`

위와 같은 방식으로 임계영역을 적용할 수 있다.

- `this` 를 넣어주는 것은, **해당 인스턴스의 락을 가져와야 한다**는 의미이다.

임계 영역을 최소화함으로써 **전체적인 처리 성능**을 어느 정도 높여줄 수 있다.

### synchronized 동기화 정리

자바에서 `synchronized` 는 멀티스레드 환경에서 공유 자원에 대한 동시성 문제를 해소하기 위한 메커니즘이다.

#### 메서드 동기화

**메서드**를 `synchronized`로 선언하여, **메서드에 접근 가능한 스레드가 하나뿐이도록 보장**한다.

#### 블록 동기화

**코드 블록**을 `synchronized`로 감싸서 동기화 영역을 한정할 수 있다.


