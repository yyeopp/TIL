# Chapter 3: 운영체제

---

# Section 2: 메모리

CPU는 그저 **메모리**에 올라와 있는 **프로그램의 명령어들을 실행하는** 존재이다.

---

## 메모리 계층

메모리 계층은 레지스터, 캐시, 메모리, 저장장치로 구성되어 있다.

### 계층 구성

- **레지스터**: **CPU 안에 있는** 작은 메모리. 휘발성, 가장 빠른 속도, 가장 적은 기억 용량

- **캐시**: L1, L2 캐시를 지칭. 휘발성, 빠른 속도, 적은 기억 용량

- **주기억장치**: **RAM**을 지칭. 휘발성, 보통 속도, 보통의 기억 용량

- **보조기억장치**: HDD, SSD를 지칭. 휘발성, 낮은 속도, 많은 기억 용량

계층이 위로 올라갈수록, **가격이 비싸지고, 용량이 작아지고, 속도가 빨라진다**.

계층을 두는 이유는 **경제성**과 **캐시** 때문.

### 작동 방식

주기억장치(RAM)은 보조기억장치(하드디스크)로부터 일정량의 데이터를 복사해서 **임시 저장**하고, 필요 시마다 **CPU**에 빠르게 **전달**하는 역할을 수행하는 구조.

- 일상적으로 게임 같은 것을 실행할 때 **로딩**이 걸리는 것은, 대부분 하드디스크나 인터넷에서 데이터를 읽어 **RAM으로 전송하는 과정**이다.

### 캐시

캐시(cache)는 **데이터를 미리 복사해 놓는 임시 저장소**이자, 빠른 장치와 느린 장치에서 **속도 차이에 따른 병목 현상을 줄이기 위한 메모리**를 말한다.

> #### 캐싱 계층
> 
> **속도 차이를 해결하기 위해 계층과 계층 사이에 있는 계층**을 일컬어 캐싱 계층이라고 말한다.
> 
> 어떤 계층의 **특성**을 설명하는 단어이다.
> 
> - 메모리 계층 상 캐시와 보조기억장치 사이에 있는 주기억장치 또한 이러한 맥락에서는 캐싱 계층의 하나가 된다.

- 메모리 계층 상의 캐시는, 레지스터와 주기억장치 사이에 존재하는 캐싱 계층을 말한다.

#### 지역성의 원리

캐시를 설정할 때는, **자주 사용하는 데이터를 기반으로** 설정해야 한다.

그리고 *자주 사용하는 데이터*의 근거가 되는 것이 **지역성**이다.

지역성은 시간 지역성과 공간 지역성으로 나뉜다.

##### 시간 지역성(temporal locality)

**최근 사용한 데이터에 다시 접근하려는 특성**을 말한다.

- for문 안에서 인덱스 역할을 하는 int값이 대표적이다.

##### 공간 지역성(spatial locality)

최근 접근한 데이터를 **이루고 있는 공간이나 그 가까운 공간에 접근하는 특성**을 말한다.

- for문으로 특정 배열을 스캔한다면, 배열 내의 각 요소들 간에 공간 지역성이 존재한다.

### 캐시히트와 캐시미스

**캐시에서 원하는 데이터를 찾은 경우**를 캐시히트, **해당 데이터가 캐시에 없어 주 메모리로 가서 데이터를 찾아오는 경우**를 캐시미스라고 한다.

- 캐시히트가 성공하면, 해당 데이터는 **CPU 내부 버스를 통해** 제어장치를 거쳐 CPU로 가져오게 된다.
  
  - 주 기억장치에 대한 접근 없이 **레지스터** 선에서 동작이 완료됨.

- 캐시미스가 발생하면 해당 데이터는 **메모리**에서 가져와야 하는데, 이 때는 **시스템 버스**를 기반으로 작동하기 때문에 **느리다**.
  
  - **주소 버스**를 통해 CPU로부터 데이터가 저장된 주소값이 메모리로 전달
  
  - **신호 버스**를 통해 CPU로부터 메모리를 Read하겠다는 신호가 메모리로 전달
  
  - **데이터 버스**를 통해 메모리로부터 지정된 주소값의 데이터를 CPU로 전달

### 시스템 버스(system bus)

**컴퓨터의 구성요소를 서로 연결하고, 데이터를 전달하기 위한 경로**.

구성요소로는 크게 CPU, 메모리, I/O Unit이 있고, 이들은 시스템 버스에 존재하는 제어 버스, 주소 버스, 데이터 버스를 이용해 서로 데이터를 전달한다.

#### 주소 버스(address bus)

메모리의 주소나 I/O Unit의 포트 번호를 전달한다.

- CPU와 메모리 간에는 CPU -> 메모리의 단방향 주소 버스만 존재한다.

- CPU, 메모리와 I/O Unit 간에는 양방향 주소 버스가 존재한다.

#### 데이터 버스(data bus)

데이터를 전달한다.

- 각 구성요소 사이에는 양방향 데이터 버스가 존재한다.

#### 제어 버스(control bus)

제어 신호를 전달한다. Read와 Write 신호가 있다.

- 각 구성요소 사이에는 양방향 데이터 버스가 존재한다.

### 캐시매핑

캐시가 히트되기 위해 **매핑하는 방법**.

일단 CPU의 레지스터와 주 메모리(RAM) 간 데이터 전송을 기준으로 할 때, 3가지 방법으로 분류 가능하다.

- 기본적으로 레지스터와 RAM의 용량 차이는 상당하기 때문에, 캐시가 캐시 계층으로써 역할을 잘 해주려면 매핑 방식이 매우 중요하다.

#### 직접 매핑(directed mapping)

캐시가 1~10, 메모리가 1~100이 있다면 1:1~10, 2:10~20 이런 식으로 매핑하는 것.

즉, 규칙에 맞춰 순차적으로 매핑하는 방식이다.

- 처리가 빠르지만, **충돌 발생이 잦다**.

#### 연관 매핑(associative mapping)

순서를 일치시키지 않고, 관련 있는 캐시와 메모리를 매핑한다.

- 충돌이 적지만, **모든 블록을 탐색**하는 것이 기본이라 속도가 느리다.

#### 집합 연관 매핑(set associative mapping)

직접 매핑과 연관 매핑을 합쳐 놓은 것으로 이해할 수 있다. **순서를 일치시키되** **집합을 둬서 저장**하며, **블록화**되어 있다. 

캐시 1~5에 메모리 1~50의 데이터를 **무작위로 저장**시키는 것이 예시.

- 검색이 좀 더 효율적이다.

### 웹 브라우저의 캐시

소프트웨어적인 캐시 중 대표적인 예시가 웹 브라우저에서 사용되는 **쿠키, 로컬 스토리지, 세션 스토리지**이다.

보통 사용자의 **커스텀 정보**나 **인증 모듈** 관련 사항들을 웹 브라우저에 저장해서, 추후 서버에 요청할 때 identification 작업을 하거나 중복 요청 방지를 할 때 사용된다.

#### 쿠키

**만료기한**이 있는 **키-값 저장소**이다. 4KB까지 데이터를 저장할 수 있다.

따로 옵션을 설정하지 않으면 다른 도메인에서 요청을 보낼 때 **자동 전송**되고, **서버에서** 보통 만료기한을 설정해준다.

#### 로컬 스토리지

만료기한이 **없는** **키-값 저장소**이다. 10MB까지 데이터를 저장할 수 있고, 웹 브라우저를 닫아도 유지되어 **도메인 단위**로 저장, 생성된다.

**HTML5**를 지원하지 않는 웹 브라우저에서 사용이 불가하며, **클라이언트에서만 수정 가능**하다.

#### 세션 스토리지

만료기한이 **없는** **키-값 저장소**이다. **탭** 단위로 세션 스토리지를 생성하고, 이를 닫을 때 데이터가 삭제된다.

5MB까지 저장 가능하고, HTML5를 지원하지 않는 웹 브라우저에서 사용이 불가하며, 클라이언트에서만 수정이 가능하다.

### 데이터베이스의 캐싱 계층

DBMS를 구축할 때도, 메인 DB 위에 **redis 데이터베이스 계층**을 **캐싱 계층**으로 둬서 성능을 향상시키기도 한다.

- **캐시히트** 시 redis에서 데이터를 읽어오고, **캐시미스** 시 그 뒷면의 메인 DB에서 데이터를 읽어오는 구조.

- 데이터를 쓰는 것도 일단 redis에 쓰고 redis가 메인 DB로 다시 전송.

---

## 메모리 관리
