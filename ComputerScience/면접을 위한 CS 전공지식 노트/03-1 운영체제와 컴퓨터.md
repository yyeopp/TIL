# Chapter 3: 운영체제

**운영체제**(OS, Operating System)는 **사용자가 컴퓨터를 쉽게 다루게 해주는 인터페이스**이다.

한정된 메모리나 시스템 자원을 효율적으로 분배하는 역할을 수행한다.

- 운영체제와 유사하나, 소프트웨어를 추가적으로 설치할 수 없는 것을 **펌웨어**(firmware)라고 한다.

---

# Section 1: 운영체제와 컴퓨터

---

## 운영체제의 역할과 구조

### 운영체제의 역할

> 용어에 대한 자세한 설명은 이후 내용에서 확인 가능

#### CPU 스케줄링과 프로세스 관리

CPU의 소유권을 어떤 프로세스에 할당할지, 프로세스의 생성과 삭제, 자원 할당 및 반환을 관리

#### 메모리 관리

한정된 메모리를 어떤 프로세스에 얼만큼 할당해야 하는지를 관리

#### 디스크 파일 관리

디스크 파일을 어떤 방법으로 보관할지 관리

#### I/O 디바이스 관리

I/O 디바이스들인 마우스, 키보드와 컴퓨터 간 데이터를 주고받는 것을 관리

### 운영체제의 구조

맨 위에 유저 프로그램이 있고, 맨 아래에 하드웨어가 있다.

그 사이에 운영체제가 4개의 층으로 쌓여있는데,

- **GUI**
  
  - 사용자가 전자장치와 상호 작용할 수 있도록 하는 사용자 **인터페이스**의 한 형태. 
  
  - 단순 명령어 창이 아닌 아이콘을 마우스로 클릭하는 등의 **단순한 동작**으로 컴퓨터와 상호 작용할 수 있도록 해준다.
  
  - GUI가 없고 **CUI**만 있는 경우가 있는데, **리눅스 서버**가 대표적이다.
    
    - CUI는 그래픽이 아닌 **명령어**로 컴퓨터와 상호 작용하는 사용자 인터페이스.

- **시스템콜**

- **커널**

- **드라이버**
  
  - 하드웨어를 제어하기 위한 **SW**

의 구조로 이루어져 있다.

#### 시스템콜

운영체제가 **커널**에 접근하기 위한 **인터페이스**.

유저 프로그램이, 운영체제의 서비스를 받기 위해 **커널 함수를 호출할 때** 사용된다.

- 유저 프로그램이 **I/O 요청으로** **인터럽트**를 발동시킴

- 그것이 올바른 요청인지 확인한 후, **유저 모드**가 시스템콜을 통해 **커널 모드**로 변환되어 실행됨.

> #### 유저 모드
> 
> 유저가 접근할 수 있는 제한된 영역.
> 
> **컴퓨터 자원**에 함부로 침범하지 못하는 모드.
> 
> #### 커널
> 
> 운영체제의 핵심 부분이자, **시스템콜 인터페이스**를 제공.
> 
> 보안, 메모리, 프로세스, 파일 시스템, I/O 디바이스, I/O 요청 관리 등 운영체제의 중추적인 역할을 수행
> 
> #### 커널 모드
> 
> **모든 컴퓨터 자원에 접근**할 수 있는 모드.

- 실행 결과는 커널 모드에서 **유저 모드로 변환된 뒤** 유저 프로그램의 로직을 수행하게 된다.

즉, 시스템콜을 활용함으로써 **컴퓨터 자원에 대한 직접 접근을 차단**할 수 있고, **프로그램을 다른 프로그램으로부터 보호**할 수 있다.

- 시스템콜은 하나의 **추상화 계층**으로 해석할 수 있다.

- 시스템콜을 활용해 커널에 접근함으로써, 유저 프로그램을 제작할 때 통신이나 메모리 같은 **낮은 단계 영역 처리에 대한 부분을 덜 신경쓰면서** 구현할 수 있다는 장점을 가지게 된다.

##### modebit

modebit은 0 또는 1의 값을 가지는 **플래그 변수**로, 시스템콜이 작동될 때 modebit을 **참고해서** 유저 모드와 커널 모드를 **구분**하게 된다.

- 기본적으로 카메라, 키보드 등 **I/O 디바이스**는 **운영체제를 통해 작동**시키는 것이 보안 상 안전하다.

- 이를 위한 장치로 활용되는 게 modebit.

modebit의 **0은 커널 모드, 1은 유저 모드**로 설정되고, modebit이 1이면 **시스템콜을 막아서** 한정된 일만 수행 가능하도록 한다.

- 정상적인 경로로 유저 프로그램이 I/O 디바이스를 요청한다면, **modebit을 1에서 0으로 바꾼 다음** 시스템콜을 호출함으로써 **커널 모드의 로직이 수행**될 수 있도록 하는 것.

- 유저 프로그램 로직으로 돌아가기 전 **modebit을 1로 바꾸는 것** 또한 잊으면 안 될 것.

---

## 컴퓨터의 요소

CPU, DMA 컨트롤러, 메모리, 타이머, 디바이스 컨트롤러 등으로 이루어져 있다.

### CPU(Central Processing Unit)

CPU는 **산술논리연산장치, 제어장치, 레지스터**로 구성되어 있는 컴퓨터 장치이다.

**인터럽트**에 의해, **메모리에 존재하는 명령어를 해석해서 실행**하는 일꾼 역할이다.

- **운영체제**의 **커널**이 프로그램을 **메모리에 올려 프로세스로 만들면** CPU가 이를 처리하는 식이다.

#### 제어장치(CU, Control Unit)

제어장치는 **프로세스 조작을 지시**하는 CPU의 한 부품이다.

**I/O 장치 간의 통신**을 제어하고, **명령어들을 읽고 해석**하며, 데이터 처리를 위한 **순서를 결정**한다.

#### 레지스터

레지스터는 CPU 안에 있는 **매우 빠른 임시기억장치**이다.

CPU에 접 연결되어 있는 덕분에 연산 속도가 메모리보다 수십에서 수백 배 빠르다.

- CPU는 자체적으로 데이터를 저장할 방법이 없기 때문에, **레지스터를 거쳐 데이터를 전달**한다.

#### 산술논리연산장치(ALU, Arithmetic Logic Unit)

산술논리연산장치는 덧셈, 뺄셈 같은 숫자 간의 **산술 연산**과 배타적 논리합, 논리곱 같은 **논리 연산**을 계산하는 디지털 회로.

##### CPU의 연산 처리 과정

- **제어장치**가 **메모리**에 계산할 값을 로드하고, **레지스터**에도 로드한다.

- **제어장치**가 **레지스터에 있는 값을 계산하라고** 산술논리연산장치에게 명령한다.

- **제어장치**가 계산된 값을 **레지스터로부터** 가져와 **메모리에 저장**한다.

### 인터럽트

인터럽트는 어떤 **신호**가 들어왔을 때 **CPU를 잠깐 정지시키는 것**을 말한다.

기본적으로 CPU 하나는 한 번에 하나의 일만 처리할 수 있기 때문에, 도중에 **우선 순위가 더 급한** 일을 처리할 필요가 생기면 이에 대처할 방안이 필요하고, 이 때 인터럽트가 사용된다.

#### 하드웨어 인터럽트

일반적으로 인터럽트를 이르는 말로, **CPU 외부로부터 인터럽트 요구 신호에 의해** 발생하는 인터럽트이다.

종류는 다음과 같다.

##### 입출력 인터럽트(I/O interrupt)

입출력 작업의 종료나 입출력 오류에 의해, CPU의 기능이 요청됨

##### 정전, 전원 이상 인터럽트(Power fail interrupt)

##### 기계 착오 인터럽트(Machine check interrupt)

CPU의 기능적인 오류

##### 외부 신호 인터럽트(External interrupt)

I/O 장치가 **아닌** **오퍼레이터**나 **타이머**에 의해 **의도적으로 프로그램이 중단**되는 경우.

#### 소프트웨어 인터럽트

**CPU 내부**에서 **자신이 실행한 명령**이나 **CPU의 명령 실행에 관련된 모듈이 변화**하는 경우에 발생하는 인터럽트.

**trap** 또는 **exception**이라고도 한다.

- 즉, 기본적으로 **프로그램의 오류**에 의해 생기는 인터럽트다.

다음과 같은 종류가 있다.

##### 프로그램 검사 인터럽트(Program check interrupt)

0으로 나누기, Overflow/Underflow, 페이지 부재, 부당한 기억장소 참조 등

##### SVC(Supervisor Call: 감시프로그램 호출) 인터럽트

사용자가 프로그램을 실행시키거나, supervisor을 호출하는 동작을 수행하는 경우.

#### 인터럽트 우선순위

여러 인터럽트가 동시에 발생하는 경우는 매우 흔하기 때문에, **우선순위**에 근거하여 **순차적으로 처리**해야 한다.

높은 우선순위부터 나열하면 다음과 같다.

- 정전, 전원 이상 인터럽트

- 기계 착오 인터럽트

- 외부 신호 인터럽트

- 입출력 인터럽트

- 프로그램 검사 인터럽트

- SVC 인터럽트

#### 인터럽트 벡터(Interrupt Vector)

여러 인터럽트에 대해, 해당 인터럽트 발생 시 처리해야 할 **루틴**(**ISR**)의 **주소를 보관하고 있는 공간**이다.

대부분의 CPU에서 가지고 있고, 인텔 x86에서는 **IDT**라고 한다.

#### 인터럽스 서비스 루틴(ISR, Interrupt Service Routine)

**인터럽트 핸들러**(Interrupt handler)라고도 한다.

인터럽트 접수 시, 각각의 인터럽트에 대응하여 특정 기능을 처리하는 **기계어 코드 루틴**이다.

**커널**이 실행한다.

#### 전반적인 과정

- 프로세스가 **처리 중**이다가, **인터럽트가 발생**하면 **처리가 정지**된다.

- **인터럽트 벡터 테이블**에서 **인터럽트 처리 루틴**의 주소값을 얻고, 그 곳으로 **점프**하여 루틴을 실행한다.

- **인터럽트 처리 루틴**은 다음과 같다.
  
  - 인터럽트 금지
  
  - 프로세서 상태 저장
  
  - 인터럽트 처리
  
  - 프로세서 상태 복구
  
  - 인터럽트 허용

- 루틴이 끝나면 인터럽트 복귀가 일어나서, 기존 프로세스가 다시 처리된다.

#### 디테일한 예시

> 프로세스 A를 실행하던 도중 **디스크에서 어떤 데이터를 읽어오라는 명령**을 받았을 때

- 프로세스 A는 **시스템콜**을 통해 **인터럽트를 발생시킨다**.

- CPU는 현재 진행 중이던 기계어 코드를 **완료**한다.

- CPU는 **현재까지 수행 중이던 상태**를 **해당 프로세스의 PCB에 저장**한다.
  
  - 수행 중이던 메모리의 주소, 레지스터 값 등 

- CPU는 **PC**(Program, Counter, IP)에 **다음 실행할 명령의 주소를 저장**한다.

- **인터럽트 벡터**를 읽어서 **ISR 주소값**을 얻고, **ISR(Interrupt Service Routine)로 점프**하여 **루틴을 실행**한다.

- 루틴을 실행하고, 처리가 완료되면 **저장했던 프로세스의 상태를 복구**한다.
  
  - ISR의 끝에 있는 **IRET 명령어**에 의해 **인터럽트가 해제**되고,
  
  - IRET 명령어 실행에 의해 대피시킨 **PC값을 복원**하여 이전 실행위치로 돌아온다.

### DMA 컨트롤러

DMA 컨트롤러는 I/O 디바이스가 **메모리에 직접 접근할 수 있도록 하는** 하드웨어 장치이다.

CPU는 그 과정에서 **상태, 제어정보**만을 교환하고 **데이터 전송 자체는** I/O와 메모리 간에 직접 발생한다.

- CPU에서는 **데이터 이동이 완료되었다는 단 한 번의 인터럽트만** 발생하게 되고,

- DMA를 통해 데이터가 전송되는 동안 CPU는 **다른 작업을 수행한다**.

#### 필요성

- 고속의 I/O 장치를 구현하기 위해, CPU에 **인터럽트**가 대량 발생함으로써 프로세스 작업 시간이 과해지는 것을 방지

- 디스크 같이 **많은 데이터를 입출력**하는 장치에 대해, CPU가 직접 매번 전송을 제어하는 것이 비효율적이기 때문

### 메모리(memory)

메모리는 전자회로에서 **데이터나 상태, 명령어 등을 기록하는 장치**이다. 보통 **RAM**(Random Access Memory)을 일컬어 메모리라고 한다. 

CPU는 메모리가 **기억**하고 있는 데이터에 대해 **계산**한다고 이해하면 빠르다.

> 자세한 내용은 뒤에 이어질 것

### 타이머(timer)

타이머는 몇 초 안에 작업이 끝나야 한다는 것을 정해 **특정 프로그램에 시간 제한을 다는 역할**을 수행한다.

- **외부 신호 인터럽트**를 발생시킨다고 위에서 다룬 바 있다.

### 디바이스 컨트롤러

컴퓨터에 연결되어 있는 **개별 I/O 디바이스들의 작은 CPU**를 말한다.

디바이스에 입력되는 신호를 받아 CPU에 **인터럽트**를 건다.
