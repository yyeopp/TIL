# Chapter 2: 네트워크

---

# Section 2: TCP/IP 4계층 모델

**인터넷 프로토콜 스위트**(internet protocol suite)는, 인터넷에서 컴퓨터들이 서로 정보를 주고받는 데 쓰이는 **프로토콜의 집합**이다.

> #### 프로토콜
> 
> 컴퓨터들 간의 원활한 통신을 위해 지키기로 약속한 규약.
> 
> 신호 처리법, 오류처리, 암호, 인증, 주소 등을 포함한다. 원활한 통신을 위해서는 반드시 프로토콜의 통일이 필요하다.
> 
> - 인터넷이 전 세계에 자유롭게 연결되는 것은 TCP/IP 프로토콜을 기반으로 동작하기 때문
> 
> - 전 세계 어느 주소로도 이메일 전송이 가능한 것은 모든 메일 서버가 SMTP 프로토콜을 준수하기 때문
> 
> - 모든 웹 서버와 웹 브라우저가 HTTP 프로토콜을 준수하기 때문에 WWW이 가능한 것.

이를 TCP/IP 4계층 모델로 설명하거나, OSI 7계층 모델로 설명할 수 있는데 전자(Transmission Control Protocol / Internet Protocol)에 대해 학습한다.

- 네트워크 통신 구조를 4개의 계층 개념으로 나누어 설명한 것이라고 이해할 수 있다.

- 네트워크 통신에 필요한 각종 기능들을 계층화하고, 복수의 프로토콜을 조합하여 실현시킨 것이 4계층 모델이다.

---

## 계층 구조

TCP/IP 계층은 4개의 계층을 가지고 있다.

- 어플리케이션 계층, 전송 계층, 인터넷 계층, 링크 계층

이러한 계층들은, **특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록** 설계되어있다.

- 전송 계층에 있는 TCP를 UDP로 변경했다고 해서, 어플리케이션 계층에 해당하는 웹 브라우저를 다시 설치해야 할 필요는 없다는 게 우연이 아니다.

서로 다른 계층 간에는 데이터 전달 과정을 구체적으로 알 필요가 없으므로, **데이터 캡슐화 ㅁ치 은닉**이 가능하다.

- 캡슐화된 데이터는 주로 헤더에 첨부된다.

### 어플리케이션 계층

FTP, HTTP, SSH, SMTP, DNS 등 **응용 프로그램이 사용되는 프로토콜 계층**이다.

웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층으로, 사용자와 가장 가까이에서 사용자와 소프트웨어 간 소통을 담당한다.

어플리케이션 기능 실행을 위한 데이터의 형식 및 처리절차 등을 결정하며, 이 때 데이터는 인간이 인식 가능한 문자나 이미지 같은 형식으로 표현된다.

80번 포트를 사용하는 http 프로토콜을 비롯한 다양한 프로토콜이 사용된다.

> #### FTP
> 
> 장치와 장치 간의 파일을 전송하는 데 사용되는 표준 통신 프로토콜
> 
> #### SSH
> 
> 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜
> 
> #### HTTP
> 
> World Wide Web을 위한 데이터 통신의 기초이자, 웹 사이트를 이용하는 데 쓰는 프로토콜
> 
> #### SMTP
> 
> 전자 메일 전송을 위한 인터넷 표준 통신 프로토콜
> 
> #### DNS
> 
> 도메인 이름과 IP 주소를 매핑해주는 서버.

### 전송 계층

송신자와 수신자를 연결하는 통신 서비스를 제공한다.

연결 지향 데이터 스트림 지원, **신뢰성**, 흐름 제어를 제공하며, 어플리케이션과 인터넷 계층 사이 데이터가 전달될 때 중계 역할을 한다.

- 데이터를 적절한 어플리케이션에 제대로 전달되도록 배분하는 역할이라고 볼 수 있다.

- 어플리케이션 계층에서 전송 계층까지가 바르게 동작했다면, 일단 출발지와 목적지 어플리케이션 간의 **제대로 된 데이터 송수신이 가능**해졌다고 확신할 수 있다.
  
  - **신뢰성**이 보장되었기 때문.

대표적으로 TCP와 UDP가 있다.

- TCP는, 패킷 사이의 **순서를 보장**하고 **연결지향 프로토콜**을 사용한 연결을 통해 **신뢰성**을 구축해서 **수신 여부를 확인**한다. **가상회선 패킷 교환 방식**을 사용한다.
  
  - 연결지향형이므로, 패킷에 하나의 오류라도 있으면 **재전송을 통해 에러를 복구**하게 된다.

- UDP는, **순서를 보장하지 않고** **수신 여부를 확인하지 않으며** 단순히 데이터만 주는 **데이터그램 패킷 교환 방식**을 사용한다.
  
  - 패킷을 중간에 잃거나 오류가 발생해도 이에 대처하지 않고 계속 데이터를 전송한다.

#### 데이터그램 패킷 교환 방식

데이터 전송 전에 **논리적 연결**이 설정되지 **않고** 패킷이 **독립적으로 이동**한다.

패킷을 수신한 라우터는 알아서 최적의 경로를 선택하여 패킷을 전송한다.

결과적으로 하나의 메시지에서 분할된 여러 패킷이 서로 다른 경로로 전송될 수 있기 때문에, **도착한 순서가 다를 수** 있다.

#### 가상회선 패킷 교환 방식

데이터 전송 전에 **논리적 연결이 설정**되는데, 이를 **가상회선**이라고 한다. **연결지향형**의 특성을 가진다.

각 패킷에는 설정된 가상회선의 **식별자**(VCI)가 포함되dj 이 가상회선을 통해 이동하게 된다.

- 데이터그램 방식에서는 라우터가 매번 경로를 선택하지만, 이 방식에서는 **처음 한 번**으로 끝나게 된다.

모든 패킷을 전송하면 **가상회선이 해제**되고 패킷들은 **전송된 순서대로 도착**하는 방식이다.

#### 비교

- 정해진 시간 안이나 대량의 데이터를 연속으로 보낼 때는 가상회선 방식이 적합하고, 짧은 메시지를 일시적으로 전송할 때는 데이터그램 방식이 적합하다.

- 네트워크 내 한 노드가 다운되면 데이터그램 방식은 알아서 다른 경로를 찾아가지만, 가상회선 방식은 해당 노드를 지나는 모든 가상회선을 잃게 된다.

#### TCP 연결 성립 과정

**3-way handshake**라는 작업을 진행함으로써 **신뢰성을 확보**한다.

> ##### SYN
> 
> SYNchronization의 약자로, **연결 요청 플래그**
> 
> ##### ACK
> 
> ACKnowledgement의 약자로, **응답 플래그**
> 
> ##### ISN
> 
> Initial Sequence Numbers의 약자로, 초기 네트워크 연결을 할 때 할당된 32비트의 고유 시퀀스 번호. 

##### SYN 단계

클라이언트는 서버에 클라이언트의 ISN을 담아 SYN을 보낸다.

- 이 때 ISN은 새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호이다.

##### SYN+ACK 단계

서버는 클라이언트의 SYN을 수신해 서버의 ISN을 보내고, 

이에 더해 승인번호(ACK)로써 클라이언트가 보낸 ISN+1을 함께 보낸다.

##### ACK 단계

클라이언트는 서버가 보낸 ISN+1 값을 승인번호로 담아 ACK를 서버에 보낸다.

##### 결과

3-way handshake 과정은 **신뢰성 구축**을 위한 작업으로, 이게 완료된 후 데이터 전송이 시작된다.

TCP는 이 과정을 거치기 때문에 신뢰성이 있는 계층이라고 하고,

UDP는 이 과정이 없기 때문에 신뢰성이 없는 계층이라고 한다.

#### TCP 연결 해제 과정

**4-way handshake** 과정이 발생한다.

##### 1번

클라이언트가 연결을 닫고자 FIN으로 설정된 세그먼트를 서버로 보낸다.

클라이언트는 FIN_WAIT_1 상태로 들어가서 서버의 응답을 기다린다.

##### 2번

서버는 클라이언트로 ACK라는 승인 세그먼트를 보낸다. 

서버 역시 CLOSE_WAIT 상태로 들어간다.

클라이언트가 ACK를 받으면, FIN_WAIT_2 상태로 들어간다.

##### 3번

서버는 ACK를 보내고 **일정 시간 이후에** 클라이언트로 FIN이라는 세그먼트를 보낸다.

##### 4번

FIN을 받은 클라이언트는 **TIME_WAIT 상태**가 되고, 다시 서버로 ACK를 보낸다.

> ##### TIME_WAIT 상태
> 
> 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태로, **지연 패킷** 등의 문제점을 해결하는 데 사용된다.
> 
> CentOS6, 우분투에는 60초로 설정되어 있고, 윈도우는 4분으로 설정되어 있다.

ACK를 받은 서버는 CLOSED 상태가 된다.

이후 클라이언트는 어느 정도의 시간을 대기한 후 연결이 닫혀 CLOSED 상태로 전환되고, 클라이언트와 서버 간의 모든 자원 연결이 해제된다.

이 때 클라이언트에 TIME_WAIT 상태를 걸어두는 이유는,

- **지연 패킷**이 발생한 경우를 대비한다. 패킷이 뒤늦게 도달하여 이를 처리하지 못한다면, **데이터 무결성** 문제가 발생한다.
  
  > ##### 데이터 무결성
  > 
  > 데이터의 정확성과 일관성을 유지하고 보증하는 것

- **두 장치의 연결이 제대로 닫혔는지 확인**하기 위해서이다. 만약 서버가 CLOSED 상태로 전환되지 못하고 LAST_ACK 상태에 머무른 상태에서 연결이 종료됐다면, 그 다음 새로운 연결을 시도할 때 **접속 오류를 유발**할 것이다.

##### 결과

결과적으로 FIN, ACK, FIN, ACK 총 4번의 교환이 이루어져야 연결이 해제된다.

---

## PDU

네트워크의 어떠한 계층에서 계층으로 데이터가 전달될 때, 한 덩어리의 단위를 PDU(Protocol Data Unit)이라고 한다.

PDU는 **제어 관련 정보**들이 포함된 **헤더**와, **데이터**를 의미하는 **페이로드**로 구성되어 있다.

계층마다 부르는 명칭이 다르다.

- 어플리케이션 계층: **메시지**

- 전송 계층: **세그먼트**(TCP), **데이터그램**(UDP)

- 인터넷 계층: **패킷**

- 링크 계층: 프레임(데이터 링크 계층), 비트(물리 계층)

똑같은 데이터를 전송하는 것은 맞지만, 각 레이어를 거치면서 **헤더 정보가 추가되기 때문에** 이름이 달라지는 것이다.

### 세그먼트

어플리케이션에서 데이터(메시지)를 전달받은 전송 계층에서는, 여러 정보를 추가해 그룹화하고 이 때부터 데이터를 세그먼트라고 부르게 된다.

추가되는 정보는,

- 발신지 포트, 목적지 포트, 순서 번호, 오류검출코드
