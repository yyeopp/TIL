# Chapter 2: 네트워크

---

# Section 2: TCP/IP 4계층 모델

**인터넷 프로토콜 스위트**(internet protocol suite)는, 인터넷에서 컴퓨터들이 서로 정보를 주고받는 데 쓰이는 **프로토콜의 집합**이다.

> #### 프로토콜
> 
> 컴퓨터들 간의 원활한 통신을 위해 지키기로 약속한 규약.
> 
> 신호 처리법, 오류처리, 암호, 인증, 주소 등을 포함한다. 원활한 통신을 위해서는 반드시 프로토콜의 통일이 필요하다.
> 
> - 인터넷이 전 세계에 자유롭게 연결되는 것은 TCP/IP 프로토콜을 기반으로 동작하기 때문
> 
> - 전 세계 어느 주소로도 이메일 전송이 가능한 것은 모든 메일 서버가 SMTP 프로토콜을 준수하기 때문
> 
> - 모든 웹 서버와 웹 브라우저가 HTTP 프로토콜을 준수하기 때문에 WWW이 가능한 것.

이를 TCP/IP 4계층 모델로 설명하거나, OSI 7계층 모델로 설명할 수 있는데 전자(Transmission Control Protocol / Internet Protocol)에 대해 학습한다.

- 네트워크 통신 구조를 4개의 계층 개념으로 나누어 설명한 것이라고 이해할 수 있다.

- 네트워크 통신에 필요한 각종 기능들을 계층화하고, 복수의 프로토콜을 조합하여 실현시킨 것이 4계층 모델이다.

---

## 계층 구조

TCP/IP 계층은 4개의 계층을 가지고 있다.

- 어플리케이션 계층, 전송 계층, 인터넷 계층, 링크 계층

이러한 계층들은, **특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록** 설계되어있다.

- 전송 계층에 있는 TCP를 UDP로 변경했다고 해서, 어플리케이션 계층에 해당하는 웹 브라우저를 다시 설치해야 할 필요는 없다는 게 우연이 아니다.

서로 다른 계층 간에는 데이터 전달 과정을 구체적으로 알 필요가 없으므로, **데이터 캡슐화 ㅁ치 은닉**이 가능하다.

- 캡슐화된 데이터는 주로 헤더에 첨부된다.

### 어플리케이션 계층

FTP, HTTP, SSH, SMTP, DNS 등 **응용 프로그램이 사용되는 프로토콜 계층**이다.

웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층으로, 사용자와 가장 가까이에서 사용자와 소프트웨어 간 소통을 담당한다.

어플리케이션 기능 실행을 위한 데이터의 형식 및 처리절차 등을 결정하며, 이 때 데이터는 인간이 인식 가능한 문자나 이미지 같은 형식으로 표현된다.

80번 포트를 사용하는 http 프로토콜을 비롯한 다양한 프로토콜이 사용된다.

> #### FTP
> 
> 장치와 장치 간의 파일을 전송하는 데 사용되는 표준 통신 프로토콜
> 
> #### SSH
> 
> 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜
> 
> #### HTTP
> 
> World Wide Web을 위한 데이터 통신의 기초이자, 웹 사이트를 이용하는 데 쓰는 프로토콜
> 
> #### SMTP
> 
> 전자 메일 전송을 위한 인터넷 표준 통신 프로토콜
> 
> #### DNS
> 
> 도메인 이름과 IP 주소를 매핑해주는 서버.

### 전송 계층

송신자와 수신자를 연결하는 통신 서비스를 제공한다.

연결 지향 데이터 스트림 지원, **신뢰성**, 흐름 제어를 제공하며, 어플리케이션과 인터넷 계층 사이 데이터가 전달될 때 중계 역할을 한다.

- 데이터를 적절한 어플리케이션에 제대로 전달되도록 배분하는 역할이라고 볼 수 있다.

- 어플리케이션 계층에서 전송 계층까지가 바르게 동작했다면, 일단 출발지와 목적지 어플리케이션 간의 **제대로 된 데이터 송수신이 가능**해졌다고 확신할 수 있다.
  
  - **신뢰성**이 보장되었기 때문.

대표적으로 TCP와 UDP가 있다.

- TCP는, 패킷 사이의 **순서를 보장**하고 **연결지향 프로토콜**을 사용한 연결을 통해 **신뢰성**을 구축해서 **수신 여부를 확인**한다. **가상회선 패킷 교환 방식**을 사용한다.
  
  - 연결지향형이므로, 패킷에 하나의 오류라도 있으면 **재전송을 통해 에러를 복구**하게 된다.

- UDP는, **순서를 보장하지 않고** **수신 여부를 확인하지 않으며** 단순히 데이터만 주는 **데이터그램 패킷 교환 방식**을 사용한다.
  
  - 패킷을 중간에 잃거나 오류가 발생해도 이에 대처하지 않고 계속 데이터를 전송한다.

#### 데이터그램 패킷 교환 방식

데이터 전송 전에 **논리적 연결**이 설정되지 **않고** 패킷이 **독립적으로 이동**한다.

패킷을 수신한 라우터는 알아서 최적의 경로를 선택하여 패킷을 전송한다.

결과적으로 하나의 메시지에서 분할된 여러 패킷이 서로 다른 경로로 전송될 수 있기 때문에, **도착한 순서가 다를 수** 있다.

#### 가상회선 패킷 교환 방식

데이터 전송 전에 **논리적 연결이 설정**되는데, 이를 **가상회선**이라고 한다. **연결지향형**의 특성을 가진다.

각 패킷에는 설정된 가상회선의 **식별자**(VCI)가 포함되어 이 가상회선을 통해 이동하게 된다.

- 데이터그램 방식에서는 라우터가 매번 경로를 선택하지만, 이 방식에서는 **처음 한 번**으로 끝나게 된다.

모든 패킷을 전송하면 **가상회선이 해제**되고 패킷들은 **전송된 순서대로 도착**하는 방식이다.

#### 비교

- 정해진 시간 안이나 대량의 데이터를 연속으로 보낼 때는 가상회선 방식이 적합하고, 짧은 메시지를 일시적으로 전송할 때는 데이터그램 방식이 적합하다.

- 네트워크 내 한 노드가 다운되면 데이터그램 방식은 알아서 다른 경로를 찾아가지만, 가상회선 방식은 해당 노드를 지나는 모든 가상회선을 잃게 된다.

#### TCP 연결 성립 과정: 신뢰성 확보

**3-way handshake**라는 작업을 진행함으로써 **신뢰성을 확보**한다.

- 해당 작업은 **검사합**(checksum)이라 불리는 중복 및 오류 검사의 일종이다.

> ##### SYN
> 
> SYNchronization의 약자로, **연결 요청 플래그**
> 
> ##### ACK
> 
> ACKnowledgement의 약자로, **응답 플래그**
> 
> ##### ISN
> 
> Initial Sequence Numbers의 약자로, 초기 네트워크 연결을 할 때 할당된 32비트의 고유 시퀀스 번호. 

##### SYN 단계

클라이언트는 서버에 클라이언트의 ISN을 담아 SYN을 보낸다.

- 이 때 ISN은 새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호이다.

##### SYN+ACK 단계

서버는 클라이언트의 SYN을 수신해 서버의 ISN을 보내고, 

이에 더해 승인번호(ACK)로써 클라이언트가 보낸 ISN+1을 함께 보낸다.

##### ACK 단계

클라이언트는 서버가 보낸 ISN+1 값을 승인번호로 담아 ACK를 서버에 보낸다.

##### 결과

3-way handshake 과정은 **신뢰성 구축**을 위한 작업으로, 이게 완료된 후 데이터 전송이 시작된다.

TCP는 이 과정을 거치기 때문에 신뢰성이 있는 계층이라고 하고,

UDP는 이 과정이 없기 때문에 신뢰성이 없는 계층이라고 한다.

#### TCP 연결 성립 과정: 그 외 TCP의 역할

##### 흐름제어

수신 측 버퍼의 오버플로우를 방지함: **Window Size** 설정

##### 혼잡제어

전송되는 패킷 데이터가 과도하게 많아져 혼잡을 초래하는 상황을 방지함

#### TCP 연결 해제 과정

**4-way handshake** 과정이 발생한다.

##### 1번

클라이언트가 연결을 닫고자 FIN으로 설정된 **세그먼트**를 서버로 보낸다.

클라이언트는 FIN_WAIT_1 상태로 들어가서 서버의 응답을 기다린다.

> **세그먼트**가 뭔지는 PDU 파트 참고.

##### 2번

서버는 클라이언트로 ACK라는 승인 세그먼트를 보낸다. 

서버 역시 CLOSE_WAIT 상태로 들어간다.

클라이언트가 ACK를 받으면, FIN_WAIT_2 상태로 들어간다.

##### 3번

서버는 ACK를 보내고 **일정 시간 이후에** 클라이언트로 FIN이라는 세그먼트를 보낸다.

##### 4번

FIN을 받은 클라이언트는 **TIME_WAIT 상태**가 되고, 다시 서버로 ACK를 보낸다.

> ##### TIME_WAIT 상태
> 
> 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태로, **지연 패킷** 등의 문제점을 해결하는 데 사용된다.
> 
> CentOS6, 우분투에는 60초로 설정되어 있고, 윈도우는 4분으로 설정되어 있다.

ACK를 받은 서버는 CLOSED 상태가 된다.

이후 클라이언트는 어느 정도의 시간을 대기한 후 연결이 닫혀 CLOSED 상태로 전환되고, 클라이언트와 서버 간의 모든 자원 연결이 해제된다.

이 때 클라이언트에 TIME_WAIT 상태를 걸어두는 이유는,

- **지연 패킷**이 발생한 경우를 대비한다. 패킷이 뒤늦게 도달하여 이를 처리하지 못한다면, **데이터 무결성** 문제가 발생한다.
  
  > ##### 데이터 무결성
  > 
  > 데이터의 정확성과 일관성을 유지하고 보증하는 것

- **두 장치의 연결이 제대로 닫혔는지 확인**하기 위해서이다. 만약 서버가 CLOSED 상태로 전환되지 못하고 LAST_ACK 상태에 머무른 상태에서 연결이 종료됐다면, 그 다음 새로운 연결을 시도할 때 **접속 오류를 유발**할 것이다.

##### 결과

결과적으로 FIN, ACK, FIN, ACK 총 4번의 교환이 이루어져야 연결이 해제된다.

### 인터넷 계층

장치로부터 받은 네트워크 패킷을, **IP 주소**로 지정된 목적지로 전송하기 위해 사용되는 계층.

IP, ARP, ICMP 등이 있으며, 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달한다.

상대방이 제대로 받았는지는 보장하지 않는 **비연결지향적**인 특징을 가진다.

> IP주소에 대해서는 이후 다시 다룰 예정

- 네트워크끼리 연결하고 데이터를 전송하는 기기를 **라우터**라 하고,

- 라우터에 의한 네트워크 간 전송을 **라우팅**이라고 한다.

- 라우터는 내부의 **라우팅 테이블**을 통해 경로 정보를 등록하여 데이터 전송을 위한 최적의 경로를 찾는다.
  
  - 이러한 출발지와 목적지 간 데이터 전송 과정을 **End-to-End 통신**이라고 부른다.

### 링크 계층

전선, 광섬유, 무선 등으로 실질적으로(**물리적으로**) 데이터를 전달하며, 장치 간에 신호를 주고받는 **규칙**을 정하는 계층.

**네트워크 연결 계층**이라고도 부르고, *물리* 계층과 *데이터 링크* 계층으로 다시 나누기도 한다.

- 물리 계층은 LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층

- 데이터 링크 계층은 **이더넷 프레임**을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층
  
  - **이더넷 헤더**와 함께 인터넷 계층에서 전달받은 **패킷**의 반대쪽 끝에, **트레일러**를 붙임으로써 수행된다.

#### 유선 LAN(IEEE802.3)

유선 LAN을 이루는 이더넷은 IEEE802.3 프로토콜을 따르며, 전이중화 통신을 쓴다.

##### 전이중화 통신

**양쪽 장치가 동시에 송수신할 수 있는 방식**을 말한다.

양쪽 장치는 모두 **송신로와 수신로**를 가지고 있어서, **같은 시간**에 데이터를 주고받을 수 있다.

##### CSMA/CD

이전의 유선 LAN에서 사용했던 방식으로, **반이중화 통신**의 하나다.

수신로와 송신로가 분리되어 있지 않고 **하나의 경로로만** 데이터가 이동하기 때문에, **충돌**에 대비해야 한다.

데이터를 **일단 보내고** 충돌이 발생하면 일정 시간 이후 재전송하는 방식이다.

#### 유선 LAN을 이루는 케이블

##### 트위스트 페어 케이블

하나의 케이블처럼 보이지만 실제로는 8개의 구리선을 두 개씩 꼬아서 묶은 케이블을 지칭.

- 구리선을 실드 처리하지 않고 덮은 UTP 케이블과, 실드 처리하고 덮은 STP 케이블로 나뉜다.

- 흔히 사용하는 LAN 케이블은 UTP이다.

- LAN 케이블을 꽂을 수 있는 커넥터를 RJ-45 커넥터라고 한다.

##### 광섬유 케이블

광섬유로 만든 케이블로, 레이저를 이용해 통신하기 때문에 구리선 대비 장거리 및 고속 통신이 가능하다.

광섬유의 내부와 외부를 다른 밀도를 가지는 유리나 플라스틱 섬유로 제작해서, 한 번 들어간 빛이 내부에서 계속적으로 반사하며 전진, 반대편 끝까지 나아가는 원리를 이용한다.

- 이 때 빛의 굴절률이 높은 부분을 **코어**, 낮은 부분을 **클래딩**이라고 한다.

#### 무선 LAN(IEEE802.11)

무선 LAN 장치의 경우 송수신에 **같은 채널**을 사용해야하기 때문에 **반이중화 통신**을 사용한다.

##### 반이중화 통신

양쪽 장치는 서로 통신할 수 있지만, **동시에는 통신할 수 없고** 한 번에 한 방향만 통신할 수 있는 방식이다.

- 장치가 신호를 수신하기 시작하면 그에 응답하기 전에 전송이 모두 완료될 때까지 기다려야 한다.

- 동시에 전송을 수행하면 **충돌**이 발생하기 때문에, 충돌 방지 시스템이 필요하다.

##### CSMA/CA

반이중화 통신의 하나로, 장치에서 데이터를 보내기 **전**에 **캐리어 감지** 등을 통해 사전에 가능한 한 충돌을 방지하는 방식이다.

- 데이터 송신 전, 무선 매체를 살핀다.

- **캐리어 감지**: 회선이 비어 있는지 여부를 확인한다.

- **IFS**(Inter FrameSpace): 회선이 비어있지 않다면 랜덤값을 기반으로 정해진 시간만큼 **기다리며**, 만약 무선 매체가 사용 중이면 점차 그 간격을 늘려가며 기다린다.

- 이후에 데이터를 송신한다.

#### 무선 LAN을 이루는 주파수

무선 LAN은 무선 신호 전달 방식을 이용해 2대 이상의 장치를 연결하는 기술.

기본적으로 비유도 매체인 공기에 주파수를 쏘아 무선 통신망을 구축하는데, 주파수 대역은 2.4Ghz 또는 5Ghz 대역 중 하나를 사용한다.

- 2.4Ghz는 장애물에 강하지만, 전자레인지나 무선 등에 전파 간섭이 잦다.

- 5GHz는 가용 채널 수도 많고 동시에 사용이 가능하기 때문에, 상대적으로 전파 환경 구축에 유리하다.

##### 와이파이

wifi는 전자기기들이 무선 LAN 신호에 연결할 수 있게 하는 기술로, 이를 사용하려면 **무선 접속 장치**(AP, Access Point)가 있어야 한다.

- 흔히 이걸 **공유기**라고 한다.

유선 LAN에 흐르는 신호를 무선 LAN 신호로 바꿔주어, 신호가 닿는 범위 내에서는 무선 인터넷을 사용할 수 있게 된다.

##### BSS

Basic Service Set은 **기본 서비스 집합**을 의미하며, 단순 공유기를 통해 네트워크에 접속하는 것이 아닌 **동일 BSS 내에 있는 AP들과 장치들이 서로 통신**이 가능한 구조를 말한다.

근거리 무선 통신을 제공하고, 하나의 AP만을 기반으로 구축되기 때문에 사용자가 다른 곳으로 자유롭게 이동하며 네트워크에 접속하는 것은 불가능하다.

##### ESS

Extended Service Set은 하나 이상의 연결된 BSS 그룹이다. **장거리 무선 통신**을 제공하며, BSS보다 더 많은 가용성과 이동성을 지원한다.

#### 이더넷 프레임

데이터 링크 계층은 이더넷 프레임을 통해, 전달받은 데이터의 에러를 검출하고 캡슐화한다.

##### Preamble

이더넷 프레임이 시작임을 알리는 부분

##### SFD(Start Frame Delimiter)

이 다음 바이트부터 **MAC 주소 필드**가 시작됨을 알림

##### DMAC, SMAC

수신, 송신 MAC 주소

> ##### MAC 주소
> 
> 컴퓨터나 노트북 등 각 장치에는 네트워크에 연결하기 위한 장치인 **LAN 카드**가 있다.
> 
> 이를 구별하기 위한 식별번호를 MAC 주소라 한다. 6바이트(48비트)로 구성된다.

##### EtherType

데이터 계층 위의 계층인 IP 프로토콜을 정의한다. IPv4 또는 IPv6이 된다.

##### Payload

전달받은 데이터

##### CRC

에러 확인 비트. 이더넷 프레임의 끝부분.

### 계층 간 데이터 송수신 과정

> 그래서, 내 컴퓨터가 다른 컴퓨터로 데이터를 요청한다면 어떤 일이 일어날까?

- 내 쪽에서 출발한 데이터는 어플리케이션 - 전송 - 인터넷 - 링크 계층을 지나고, 도착점에서 반대로 링크 - 인터넷 - 전송 - 어플리케이션 계층을 차례대로 지나며 전달이 이루어진다.

- 어플리케이션 계층에서 전송 계층으로 **캡슐화** 과정을 거쳐 전달되고, 링크 계층을 통해 도착점 서버와 통신을 하고, 도착점 서버의 링크계층부터 어플리케이션까지 **비캡슐화** 과정을 거쳐 데이터가 전달된다.

#### 캡슐화 과정

**상위 계층의 헤더와 데이터**를 **하위 계층의 데이터** 부분에 포함시키고, **해당 계층의 헤더**를 삽입하는 과정을 말한다.

- 어플리케이션 계층에서는 단순 **데이터**다. **메시지**라고도 한다.

- 전송 계층으로 전달되면서 **세그먼트**가 되는데(TCP의 경우), 이 때 **TCP 헤더**가 앞에 붙는다.

- 인터넷 계층으로 가면서 **패킷**이 되는데, 이 때 **IP(L3)** 헤더가 앞에 붙는다.

- 링크 계층으로 가면서 **프레임**이 되는데, 이 때 **프레임 헤더**가 앞에 붙고 **프레임 트레일러**가 뒤에 붙는다.

#### 비캡슐화 과정

하위 계층으로 상위 계층으로 가면서, **각 계층의 헤더 부분을 제거하는** 과정이다.

캡슐화 과정이 거꾸로 진행된다고 이해하면 된다.

- 최종적으로, 도착점에 있는 사용자에게 **어플리케이션의 PDU**인 **메시지**의 형태로 전달된다.

---

## PDU

네트워크의 어떠한 계층에서 계층으로 **데이터가 전달**될 때, **한 덩어리의 단위**를 PDU(Protocol Data Unit)이라고 한다.

PDU는 **제어 관련 정보**들이 포함된 **헤더**와, **데이터**를 의미하는 **페이로드**로 구성되어 있다.

계층마다 부르는 명칭이 다르다.

- 어플리케이션 계층: **메시지**

- 전송 계층: **세그먼트**(TCP), **데이터그램**(UDP)

- 인터넷 계층: **패킷**

- 링크 계층: **프레임**(데이터 링크 계층), 비트(물리 계층)

똑같은 데이터를 전송하는 것은 맞지만, 각 레이어를 거치면서 **헤더 정보가 추가되기 때문에** 이름이 달라지는 것이다.

- 당연하게도 PDU 중 가장 아래 계층인 비트로 송수신하는 것이 모든 PDU 중 가장 빠르고 효율적이지만, 사용자가 직접 컨트롤해야 하는 어플리케이션 계층에서 문자열 기반으로 메시지를 구성하는 게 편리한 것처럼 계층마다 특색을 맞추기 위해 PDU가 각기 다른 것이다.

### 세그먼트

어플리케이션에서 데이터(메시지)를 전달받은 전송 계층에서는, 여러 정보를 추가해 그룹화하고 이 때부터 데이터를 세그먼트라고 부르게 된다.

TCP 프로토콜에서 데이터가 **TCP 세그먼트**의 형태로 전송되는데, 이것은 어플리케이션 계층에서 보내진 데이터에 **TCP 헤더가 추가된 것.**

#### TCP 헤더

##### 시퀀스 번호

데이터 전송의 순서 보장을 위한 정보. 데이터가 분할된 경우 시퀀스 번호를 통해 어떻게 분할되었는 지 알 수 있다.

##### ACK 번호

응답 번호. 수신측 프로세스에서 수신한 바이트 수를 제대로 응답하기 위해 사용

##### Flags

SYN, ACK 등 제어번호가 담긴 제어 비트 영역

##### Window Size

수신 윈도우의 버퍼 크기를 지정할 때 사용.

사이즈가 0이면, 송신 프로세스가 전송을 중지함.

##### 포트 번호

TCP 프로토콜을 통해 연결되는, 송수신측에 할당되는 포트 번호

##### 검사합(checksum)

세그먼트에 포함된 헤더 및 데이터에 대한 오류 검출 용도.
