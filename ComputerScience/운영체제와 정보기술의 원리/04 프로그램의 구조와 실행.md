# Chapter 04: 프로그램의 구조와 실행

---

## 프로그램의 구조와 인터럽트

프로그램은 기본적으로 함수로 구성된다.

프로그램이 CPU에서 명령을 수행하려면, 해당 명령을 담은 프로그램의 **주소 영역**이 메모리에 올라가 있어야 한다.

- 프로그램의 주소 영역은 크게 **코드, 데이터, 스택** 영역으로 구분된다.

- 코드 영역은 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 **기계어** 명령으로 변환되어 저장되는 부분이다.

- 데이터 영역은 **전역 변수** 같이 프로그램이 사용하는 데이터를 저장한다.

- 스택 영역은 함수 호출 시 호출된 함수의 수행을 마치고 복귀할 수 있도록 주소 및 데이터를 **임시로 저장**하는 공간이다.
  
  - 함수 호출 시, 다음에 실행할 명령의 **메모리 위치**가 바뀌는 효과가 발생하기 때문에 원래 함수가 수행되던 주소가 필요한 것.

**인터럽트**의 동작 원리 또한 함수와 비슷한 스택 구조를 활용한다.

- 인터럽트로 CPU를 빼앗긴 사용자 프로그램이 어디까지 수행되었는지는, 운영체제가 관리하는 **프로세스 제어블록**(**PCB**)에 저장되고 있다.

---

## 컴퓨터 시스템의 작동 개요

CPU는, 기본적으로 매 시점 메모리의 특정 주소에 존재하는 명령을 하나씩 읽어와 그대로 실행한다.

이 때 CPU가 수행해야 할 **메모리 주소**를 담고 있는 **레지스터**를 **프로그램 카운터**(PC)라고 부른다.

메모리에는 사용자 프로그램들과 운영체제가 같이 올라가 있는데, CPU는 프로그램 카운터가 **가리키고 있는 메모리 위치**의 프로그램을 수행할 뿐이다.

- 프로그램 카운터가 운영체제 부분을 가리키고 있다면 CPU가 **커널모드**에서 수행 중이라고 보면 되고,

- 사용자 프로그램 부분을 가리키고 있다면 **사용자모드**에서 수행 중이라고 보면 된다.

사용자 프로그램이 특권명령 수행을 필요로 하여 운영체제에 시스템 콜을 보내는 **인터럽트**에 대응하기 위해, CPU는 매번 명령을 수행한 직후 **인터럽트 라인**을 체크하여 서비스 요청이 들어왔는지 확인한다.

- 이 때 인터럽트의 종류가 다양하므로, 각 발생 원인마다 라인을 다르게 해서 구분하고 있다.

---

## 프로그램의 실행

프로그램이 실행된다는 것은 컴퓨터 시스템 차원에서,

- 디스크에 존재하던 실행파일이 **메모리에 적재**된다는 것과

- 프로그램이 **CPU를 할당받아 명령을 수행**하고 있는 상태라는 것을 의미한다.

- 여러 프로그램이 메모리에 동시에 적재되어 짧은 시간 단위로 CPU를 나눠쓰는 것에 대해, *여러 프로그램이 동시에 실행된다*는 표현을 흔히 사용한다.

프로그램 주소 공간 중 당장 CPU 수행에 필요한 부분은 메모리에, 그렇지 않은 부분은 디스크 내 스왑 영역에 두어 메모리 공간을 효율화한다.

프로세스의 주소 공간은 코드, 데이터, 스택으로 구성되는데, 각각 프로그램마다 이들을 별도로 가진다.

- 이러한 주소 공간을 **가상메모리** 또는 **논리적 메모리**라고 부르며, 실제 물리적 메모리와 분리된 모습을 표현한다.

운영체제 또한 코드, 데이터, 스택의 주소 공간을 가지는 하나의 프로그램이다.

- 커널의 **코드**에는, CPU, 메모리 등 자원관리와 인터페이스 제공 기능, 시스템 콜 및 인터럽트 처리 기능이 들어있다.

- **데이터** 영역에는, 각종 자원 관리를 위한 자료구조가 저장된다.
  
  - 현재 수행 중인 프로세스의 상태, CPU 사용 정보, 메모리 사용 정보 등을 **유지하기 위한** PCB 자료구조를 두고 있다.

- **스택** 영역은, 일반 사용자 프로그램의 스택과 달리 **현재 수행 중인 프로세스마다 별도의 스택을 두어** 관리한다.
  
  - 프로세스가 시스템 콜을 호출하고, 시스템 콜 내부에서 다른 함수를 호출하는 경우 그 복귀 주소는 **커널 내부**가 되기 때문에, 사용자 프로그램의 스택과 달리 **별도의 저장공간**이 필요하다.
  
  - 커널이 공유 코드로서 모든 사용자 프로그램이 시스템 콜을 통해 **커널 함수에 접근**할 수 있는 것도 문제다.
  
  - 즉, 일관성 유지를 위해 각 프로세스마다 커널 내 별도의 스택을 둔다.

- 정리하면,
  
  - 각 프로그램은 자신의 코드 내에서 함수를 호출한 이후 복귀 주소를 유지하기 위해 **자기 주소 공간 내의 스택**를 이용한다.
  
  - 시스템 콜, 인터럽트 등으로 운영체제의 코드가 실행되던 중 함수 호출이 발생하면, 운영체제가 프로세스마다 마련해둔 **커널 스택**을 사용한다.
  
  - 단, 시스템 콜에 의해 CPU 수행 주체가 운영체제로 바뀌는 순간 **프로그램의 복귀 정보**는 PCB에 저장된다.

---

## 사용자 프로그램이 사용하는 함수

크게 사용자 정의함수, 라이브러리 함수, 커널함수의 세 가지로 구분할 수 있다.

**사용자 정의함수**는 프로그래머가 직접 작성한 함수다.

**라이브러리 함수**는 이미 누군가 작성한 함수를 호출만 하여 사용하는 경우다.

- 위 둘은 모두 프로그램의 **코드 영역**에 기계어 명령 형태로 존재한다.

- 프로그램 실행 시, 해당 프로세스의 **주소 공간**에 포함되고 함수 호출 시에도 **자기 주소 공간 내 스택**을 사용한다.

**커널함수**는 운영체제 커널의 코드에 정의된 함수다. 두 종류가 있다.

- 사용자 프로그램이 운영체제 서비스를 요청하기 위해 호출하는 **시스템 콜** 함수

- 각종 하드웨어 및 소프트웨어가 CPU 서비스를 요청하기 위해 발생시키는 **인터럽트** 처리 함수

- 위와 같은 커널 함수는 커널의 주소 공간에 코드가 정의되고, 사용자 프로그램은 시스템 콜을 통해 해당 함수를 호출해서 사용한다.

---

## 인터럽트

인터럽트 라인 체크를 통해 현재 수행 중이던 프로세스가 중단되고 인터럽트 처리루틴이 가동된다.

인터럽트 처리 중 또 다른 인터럽트가 발생하는 경우가 있을 수 있는데, 원칙적으로 **데이터 일관성** 문제로 허용되지 않는다.

- 하지만, 더 시급한 사안이여서 CPU를 당장 사용해야 하는 경우 예외가 존재할 수 있다.

- 그래서 현재 처리 중인 인터럽트보다 더 높은 우선순위의 인터럽트가 발생하면, 현재 처리 중이던 **인터럽트 코드의 수행 지점을 저장**하고 새로운 인터럽트를 처리한다.

---

## 시스템 콜


