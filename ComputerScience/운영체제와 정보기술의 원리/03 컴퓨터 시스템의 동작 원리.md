# Chapter 03: 컴퓨터 시스템의 동작 원리

---

## 컴퓨터 시스템의 구조

컴퓨터 시스템은 **컴퓨터 내부장치**인 CPU, 메모리와 **컴퓨터 외부장치**인 디스크, 키보드, 마우스, 모니터, 네트워크 장치로 구성된다.

컴퓨터 업무는 기본적으로, 외부장치에서 내부장치로 데이터를 읽어와(**input**) 각종 연산을 수행하고 결과를 외부장치로 다시 내보내는(**output**) 과정이다. 

- 그런 측면에서 컴퓨터 외부장치를 **입출력 장치**라고 부를 수도 있다.

기본적으로 연산은 CPU에서 이루어지지만, 메모리 및 입출력 장치 등 각 하드웨어 장치에는 **컨트롤러**가 붙어있다.

- 컨트롤러는 작은 CPU로, 각 하드웨어를 제어한다.

이러한 구조 속에서 **운영체제**는, 여러 프로그램이 **동시에** 수행되는 **시스템**을 위한 운영체제다.

- 프로그램이 수행되려면 메모리에 올라가 있어야 하는데, 운영체제는 부팅 이후부터 항상 수행되면서 각종 자원들을 관리해야 하므로 **항상** 메모리에 올라가 있다.

- 운영체제의 모든 코드를 메모리에 올릴 필요는 없으므로, 그 중 핵심적인 부분만 상주하게 되고 이를 **커널**이라 한다.

---

## CPU 연산과 I/O 연산

입출력 장치들의 I/O 연산은 입출력 **컨트롤러**가 담당하고, 컴퓨터 내 수행되는 연산은 메인 CPU가 담당한다.

- 이 때 입출력 장치와 메인 CPU는 동시 수행이 가능하다. 두 가지 일이 서로 다른 곳에서 발생하기 때문.

각 장치에 설치된 **장치 컨트롤러**에는 장치로부터 들어오고 나가는 데이터를 **임시로 저장**하기 위한 작은 메모리를 가지고 있는데, 이를 **로컬 버퍼**라고 한다.

내부장치에서 실행 중인 프로그램이 디스크에서 데이터를 읽어오고자 하는 경우,

- **디스크 컨트롤러**는 디스크에서 내용을 읽어 자신의 **로컬 버퍼**에 저장한다.

- 메인 CPU는 *컨트롤러가 로컬 버퍼로 데이터를 읽어오는 작업*이 끝났는 지 지속적으로 체크하지 않는다.

- 대신, 디스크 컨트롤러가 작업이 완료되면 **인터럽트**를 발생시켜 CPU에 보고하게 된다.
  
  - 인터럽트는 컨트롤러들이 CPU의 서비스가 필요할 때 이를 통보하는 방법이다.

- 기본적으로 CPU는 매 시점 메모리에서 명령을 하나씩 읽어서 수행하는데,

- CPU 옆에는 **인터럽트 라인**이 있어서 CPU가 작업을 수행하던 중 인터럽트 라인에 신호가 들어오면 **하던 일을 멈추고** 인터럽트를 처리하게 된다.
  
  - 보다 정확히는, CPU는 **명령 하나를 수행할 때마다** 인터럽트 발생 여부를 확인한다.

- 인터럽트 발생이 확인되면, CPU는 메모리의 다음 명령을 수행하기 전에 인터럽트를 처리한다.

---

## 인터럽트의 일반적 기능

운영체제의 커널에는 인터럽트가 들어왔을 때 해야 할 일이 이미 프로그래밍되어 있다.

- 이를 **인터럽트 처리 루틴**이라고 하는데, 운영체제가 해야 할 일 중 **사용자 프로그램**에 필요한 서비스를 담고 있다고 볼 수 있다.

- 인터럽트 처리 루틴은, 로컬 버퍼에 있는 내용을 사용자 프로그램의 메모리로 전달하고, 해당 프로그램이 CPU를 할당받을 경우 다음 명령 수행이 가능함을 **표시**해두는 한다.

인터럽트는 하드웨어 인터럽트와 소프트웨어 인터럽트로 구분된다.

- 양자는 인터럽트 라인에 신호를 보내는 방식이 동일하다.

- 하지만 **하드웨어** 인터럽트의 경우 컨트롤러 같은 **하드웨어** 장치가 CPU의 인터럽트 라인을 세팅하는 반면,

- **소프트웨어** 인터럽트는 소프트웨어가 그 일을 수행한다는 차이가 있다.

운영체제는 인터럽트 발생 시 그 처리를 위해 정의된 코드(**인터럽트 처리 루틴**, **인터럽트 핸들러**)를 찾게 되는데, 코드를 쉽게 찾아가기 위해 **인터럽트 벡터**를 가지고 있다.

- 인터럽트 벡터는 인터럽트 종류마다 **번호**를 정해서, 번호에 따라 처리해야 할 코드가 위치한 부분을 가리키는 **자료구조**이다.

인터럽트 처리 루틴으로 해당 인터럽트를 처리하고 나면 원래 수행하던 작업으로 돌아가 **중단되었던 일을 계속**한다.

- 이 때 돌아갈 위치를 알아둬야 하므로 수행 중이던 작업을 **저장**해둬야 하는데, 운영체제가 별도로 가지고 있다.

### 소프트웨어 인터럽트의 경우

통상적인 인터럽트는 하드웨어 인터럽트를 의미하고, 소프트웨어 인터럽트는 **트랩**(trap)이라는 별도의 용어로 지칭되는 편이다.

트랩의 예시로는 **예외상황**(exception)과 **시스템 콜**(system call)이 있다.

- 예외상황은, 사용자 프로그램이 /0 연산 등 **비정상적인 작업**이나, 자신의 메모리 영역 바깥에 접근하려는 시도 등 **권한이 없는 작업**을 시도할 때 이를 처리하기 위해 발생시키는 인터럽트이다.

- 시스템 콜은, 사용자 프로그램이 **운영체제 내부에 정의된 코드**를 실행시키고 싶을 때 **운영체제에 서비스를 요청**하는 방법이다.
  
  - 운영체제 커널에 있는 코드를 사용자 프로그램이 실행하고자 할 땐, **인터럽트 라인 세팅**을 통해 **CPU 제어권을 운영체제로 넘겨** 실행하는 것이다.
  
  - I/O 작업이 대표적이다. 입출력 수행 코드는 프로그램 수준이 아니라 커널 수준에 존재하므로, 커널에 인터럽트를 보내는 게 필수적이다.

양자는 공통적으로 사용자 프로세스로부터 **CPU의 제어권이 운영체제에 이양**되어 처리된다는 게 중요하다.

- 그 방식을 구체화하면 결국 **인터럽트 라인 세팅**을 통해 인터럽트를 발생시키는 것이므로,

- 트랩이 인터럽트의 범주에 포함되는 것이다.

---

## 인터럽트 핸들링(interrupt handling)

인터럽트 핸들링(인터럽트 처리 루틴)은, 인터럽트가 발생한 경우 처리해야 할 일의 절차를 의미한다.

- CPU에서 명령이 실행될 때는 CPU 내부 **임시 기억장치**인 **레지스터**에 데이터를 읽고 쓰면서 작업을 하는데,

- 인터럽트를 처리하면 기존 레지스터 값이 전부 지워지게 되므로 CPU 내에 레지스터 상태 및 기존 명령의 메모리 주소 등 여러 부가 정보들을 저장해둬야 한다.

운영체제는 현재 시스템 내에서 실행 중인 프로그램들을 관리하기 위해 **프로세스 제어블록**(Process Control Block, **PCB**)라는 자료구조를 둔다.

- PCB는 각 프로그램마다 하나씩 존재하며, 해당 프로그램의 **어느 부분이 실행 중이었는지**를 저장한다.
  
  - 실행 중이던 코드의 메모리 주소, 레지스터 값, 하드웨어 상태 등을 저장한다.

즉 정리하면,

- 프로그램 실행 중 인터럽트 발생 시,

- 프로그램의 실행 상태는 PCB에 저장되고 CPU 제어권이 인터럽트 처리 루틴으로 넘어간다.

- 인터럽트 처리가 끝나면 저장된 상태가 PCB로부터 CPU에 복원되어, 다시 실행이 이어진다.

이러한 구조가 발전한 결과, 결과적으로 오늘날의 컴퓨터에서 운영체제는 **인터럽트가 발생할 때에만 실행**되고 있다.

시스템 부팅 후 정상 상태에 도달하면 사용자 프로그램이 계속 CPU를 사용하면 되기 떄문.

인터럽트가 발생할 때에만 운영체제 코드 부분으로 CPU가 이양되어 인터럽트 처리를 수행한다.

---

## 입출력 구조
