# Chapter 05: 네트워크 계층 - 목적지에 데이터 전달하기

---

## 네트워크 계층의 역할

> 전 세계의 수많은 네트워크는 서로 연결되어 거대한 인터넷을 이룬다. 네트워크 간 연결에 대하여.

### 네트워크 간의 연결 구조

**다른 네트워크**에 있는 목적지로 데이터를 전달하려면, **네트워크 계층**의 기술이 필요하다.

- 데이터 링크 계층에서 이더넷 프로토콜을 적용하는 것으로는, **스위치**를 통해 연결된 **같은** 네트워크에 있는 컴퓨터에 데이터를 전송하는 것까지만 가능하다.

- **네트워크 간 통신**을 통해 **인터넷**을 구성하려면, 네트워크 계층의 역할이 필수적이다.

- 그 때 필요한 네트워크 장비가 **라우터**.

**라우터**는, 데이터의 목적지가 정해졌을 때 **해당 목적지까지 어떤 경로로 가는 것이 좋은지** 알려 주는 기능을 한다.

- 목적지까지 어떤 경로로 데이터를 보낼지 결정하는 것을 **라우팅**이라고 한다.

- 이 때 당연하게도 *목적지 정보*가 있어야 하는데, **다른 네트워크**의 목적지를 식별하기 위해서는 **IP 주소**라는 주소가 필요하다.
  
  - MAC 주소만으로는 **랜** 내에서만 목적지 식별이 가능하다.

**IP 주소**란, 해당 컴퓨터가 **어떤 네트워크의 어떤 컴퓨터인지** 구분할 수 있도록 하는 주소다.

정리하면, 다른 네트워크의 컴퓨터로 데이터를 전송하기 위해서는 **IP 주소로 목적지를 지정하고** **데이터를 어떤 경로로 보낼지 결정**해야 한다. 

- 라우팅을 담당하는 장비가 라우터. **L3스위치**도 라우팅이 가능하긴 하지만 나중에 다룬다.

- 라우터는 **라우팅 테이블**이라는 자료 구조를 통해 **경로 정보를 등록하고 관리**함으로써 라우팅을 구현하고 있다.

### IP란?

IP(Internet Protocol)는 네트워크 계층에 적용되는 프로토콜이다. 데이터를 다른 네트워크에 있는 목적지까지 보내기 위한 라우팅 과정에서 IP가 필수적이다.

IP 프로토콜의 구체적인 모습으로, **네트워크 계층**에서의 캡슐화 시 **IP 헤더**가 붙는 것이 대표적이다.

- 총 12개의 정보가 IP 헤더에 포함되는데, 데이터를 정확하게 전달하기 위한 모든 정보가 담겨있다고 보면 된다.

- 버전, 헤더 길이, 서비스 유형, 전체 패킷 길이, ID, 조각 상태, 조각의 위치, TTL, 프로토콜, 헤더 체크섬, **출발지 IP 주소, 목적지 IP 주소**.

- 이렇게 **IP 프로토콜을 적용**하여 **IP 헤더가 추가되어 캡슐화된** 데이터를 **IP 패킷**이라고 한다.
  
  - 패킷이 데이터 링크 계층에 넘어가서 캡슐화되면 프레임이 되는 것.

---

## IP 주소의 구조

> 네트워크 간 통신을 하려면 IP 주소가 필요하다. IP 주소의 구조에 대하여

### IP 주소란?

데이터를 다른 네트워크의 목적지로 보내려면 IP 주소가 필요하다.

IP 주소는 **ISP**에게서 받을 수 있다.

IP 주소의 버전에는 **IPv4와 IPv6**가 있다.

- IPv4는 **32비트**로, 약 43억 개를 만들 수 있다.

- 인터넷 보급 이후 IP 주소가 부족해져서 128비트의 IPv6를 사용하기 시작했다.
  
  - IPv6로는 약 340'간' 개의 IP 주소를 만들 수 있다. (340조 X 1조 X 1조)

- 당분간은 IPv4와 IPv6가 공존할 예정이다.

IP 주소에는 **공인 IP 주소**와 **사설 IP 주소**가 있다.

- IPv4 고갈 문제가 나타난 후부터, **인터넷에 직접 연결**되는 컴퓨터나 **라우터**에 **공인 IP 주소**를 **ISP**가 할당하고, **랜**에 연결된 컴퓨터는 **사설 IP 주소**를 할당하는 정책을 사용하고 있다.
  
  - **라우터**를 기점으로 공인 IP 주소와 사설 IP 주소가 나뉘고, 동시에 WAN과 LAN이 나뉘는 구조로 볼 수 있다.
  
  - 라우터의 **DHCP** 기능을 사용해 사설 IP 주소를 자동으로 할당할 수 있다.
  
  - 결과적으로, 하나의 랜 안에 있는 컴퓨터들은 공인 IP 주소 단 한개로 인터넷에 연결되는 게 가능하다.

IP 주소는 32비트, **10진수**로 표시하고 있다.

- 32비트를 **8비트**(**옥텟**, octet) 단위로 4개로 쪼개고, 2진수 형태의 옥텟을 10진수로 변환함으로써 사람이 읽기 쉬운 형태로 변환한다.

- 10진수로 변환한 각 옥텟 사이에 `.`을 찍어서 끊으면 우리가 흔히 보는 IP 주소가 된다.

- 옥텟 하나에 **8비트**가 할당되어 있기 때문에, 자연스럽게 IP 주소를 구성하는 10진수는 0부터 **255**까지만 가능하다.

IP 주소는 **네트워크 ID**와 **호스트 ID**로 나뉜다.

- **네트워크 ID**는 **어떤 네트워크인지**를 나타내고, **호스트 ID**는 해당 네트워크의 **어느 컴퓨터인지**를 나타낸다.

---

## IP 주소의 클래스 구조

> IP 주소는 네트워크 규모에 따라 A~E 클래스로 나뉜다. 네트워크 클래스의 구조에 대하여

### IP 주소 클래스란?

32비트의 IP 주소에서 네트워크 ID와 호스트 ID의 크기를 조절함으로써, **네트워크의 크기를 조정**할 수 있다.

네트워크의 크기를 **클래스**라는 개념으로 구분하게 된다. A부터 E까지의 클래스가 나뉜다.

- **A클래스**는 대규모 네트워크 주소
  
  - 앞 8비트가 네트워크 ID, 나머지 24비트가 호스트 ID이다.
    
    - 하나의 클래스에 호스트 1677만 7214대를 등록할 수 있다.
  
  - 네트워크 ID에 해당하는 앞 8비트 (**1옥텟**)을 `01111111`까지만 사용 가능하다.
  
  - 호스트 ID에 해당하는 2,3,4옥텟은 8비트 전부를 사용 가능하기 때문에, 결과적으로
  
  - `1.0.0.0 ~ 127.255.255.255`의 범위가 A클래스이다.

- **B클래스**는 중형 네트워크 주소
  
  - 앞 16비트가 네트워크 ID, 나머지가 호스트 ID이다.
    
    - 하나의 클래스에 호스트 6만 5534대를 등록할 수 있다.
  
  - 네트워크 ID에 해당하는 1,2옥텟 중 1옥텟을 `10000000 ~ 10111111` 범위에서 사용 가능하다.
    
    - 2옥텟은 8비트 전부를 사용 가능하다.
  
  - 호스트 ID에 해당하는 3,4옥텟도 8비트 전부 사용 가능하다. 결과적으로
  
  - `128.0.0.0 ~ 191.255.255.255` 의 범위가 B클래스이다.

- **C클래스**는 소규모 네트워크 주소
  
  - 앞 24비트가 네트워크 ID, 나머지가 호스트 ID이다.
    
    - 하나의 클래스에 호스트 254대를 등록할 수 있다.
  
  - 네트워크 ID에 해당하는 1,2,3옥텟 중 1옥텟을 `11000000 ~ 11011111` 범위에서 사용 가능하다.
    
    - 2,3옥텟은 8비트 전부 사용 가능하다.
  
  - 호스트 ID에 해당하는 4옥텟도 8비트 전부 사용 가능하다. 결과적으로
  
  - `192.0.0.0 ~ 223.255.255.255`의 범위가 C클래스이다.

- **D클래스**는 멀티캐스트 주소

- **E클래스**는 연구 및 특수용도 주소

이 중 일반 네트워크는 A~C 클래스를 사용할 수 있기 때문에, 일반적으로 사용하는 IP 주소의 범위는 앞서 언급한 범위 안에 존재한다고 보면 된다. (`0.0.0.0 ~ 223.255.255.255`)

각 클래스에서 **사설 IP** 용도로 따로 사용하는 범위가 지정되어 있고, 그 부분은 **절대로** 공인 IP 주소로 사용될 수 없다.

- A클래스는 `10.0.0.0 ~ 10.255.255.255`

- B클래스는 `172.16.0.0 ~ 172.31.255.255`

- C클래스는 `192.168.0.0 ~ 192.168.255.255`

공인 IP 주소의 범위는 저 부분을 제외한 나머지라고 보면 된다.

가정용 랜은 주로 C클래스 사설 IP 주소가 사용된다.

---

## 네트워크 주소와 브로드캐스트의 주소

> 컴퓨터에 할당할 수 없는 IP 주소인 네트워크 주소와 브로드캐스트 주소

### 네트워크 주소와 브로드캐스트 주소란?

해당 주소는 컴퓨터나 라우터가 자신의 IP로 사용할 수 없는 특수한 주소다.

**C클래스**의 네트워크를 기준으로 할 때,

- 네트워크 주소는 4옥텟에 해당하는 **호스트 ID**가 10진수로 **0**인 주소이고

- 브로드캐스트 주소는 **호스트 ID**가 10진수로 **255**인 주소이다. 

**네트워크 주소**는, 해당 **네트워크 ID**를 가지는 네트워크의 **대표 주소**에 해당한다.

- C클래스 사설 IP인 `192.168.1.0`은, `192,168.1.*` 네트워크를 대표하는 주소다.
  
  - `192.168.1.6`은 `192.168.1.0`의 *네트워크 안에 있다*.

**브로드캐스트 주소**는, 해당 네트워크에 있는 컴퓨터나 장비 모두에게 **한 번에 데이터를 전송하는 데 사용**되는 IP 주소이다.

- `192.168.1.255`로 데이터를 전송하면, `192.168.1.*` 에 해당하는 모든 컴퓨터가 데이터를 받는다.

즉, 위 두 IP는 개별 컴퓨터가 자신의 IP 주소로 *절대* 등록할 수 없다.

---

## 서브넷의 구조

> 네트워크를 분할하는 것을 서브넷팅이라 한다. 서브넷의 구조에 대하여

### 서브넷이란?

A클래스 네트워크에는 하나의 네트워크에 1677만 개 이상의 호스트가 연결될 수 있다.

그 상태에서 **브로드캐스트** 패킷이 전송된다면, 그 모든 컴퓨터에 패킷이 전송되고 네트워크 혼잡이 과중될 수 있다.

이에, A클래스의 대규모 네트워크를 **작은 네트워크로 분할**하여 **브로드캐스트로 전송되는 패킷의 범위를 좁히는** 방법이 적용될 수 있다.

- 네트워크의 수 자체가 증가하기 때문에, **IP 주소를 더 효과적으로 활용**하는 방안이기도 하다.

이처럼 네트워크를 분할하는 것을 **서브넷팅**, 분할된 네트워크를 **서브넷**이라고 한다.

- 원래 A클래스는 네트워크 ID 8비트와 호스트 ID 24비트로 구성되는데, **호스트 ID로 사용되던 비트 중 일부를 가져와서** **서브넷 ID**로 설정하는 방법으로 서브넷팅이 이루어진다.

- 즉, 서브넷에 연결된 컴퓨터의 IP 주소는 **네트워크 ID, 서브넷 ID, 호스트 ID**로 구성된다.

### 서브넷 마스크란?

**서브넷 마스크**는 **네트워크 ID와 호스트 ID를 식별하기 위한** 값이다.

- IP 주소 서브넷팅 이후 어디까지가 네트워크 ID이고 어디부터 호스트 ID인지 선언해주는 값이다.

계속 사용하고 있던 **클래스** 역시 **서브네팅**이 적용된 개념이다.

- C클래스의 **디폴트** 서브넷 마스크는 `255.255.255.0` 인데, 이걸 2진수로 나타내면 1,2,3옥텟 부분에 1이 가득 차있는 형태다.
  
  - 실제 IP가 `192.168.1.3` 같이 있다고 할 때, 해당 IP의 서브넷 마스크가 위와 같다면 **AND 연산**을 적용하여 도출되는 결과는 `192.168.1.0`이 된다.
  
  - 이는, 해당 IP가 `192.168.1.0`이라는 **서브넷 네트워크 안에 존재**한다는 의미가 된다.

- A클래스, B클래스 모두 같은 방법으로 분류된 **서브넷**의 일종에 해당한다.
  
  - 네트워크 ID가 1옥텟에 머무르는 A클래스의 디폴트 서브넷 마스크는 `255.0.0.0`이고
  
  - 네트워크 ID가 2옥텟까지 오는 B클래스의 디폴트 서브넷 마스크는 `255.255.0.0`인 것은 위와 같이 **실제 IP가 어떤 서브넷 네트워크 안에 존재하는 지 식별하기 위함**이다.

**서브넷 마스크를 어떻게 적용하는지**에 따라 서브넷팅을 자유롭게 구현할 수 있다.

- 예시로 `150.150.100.1`은 B클래스에 속하는 IP이지만, 여기에 사용자가 C클래스의 디폴트 서브넷 마스크를 씌움으로써 마치 C클래스 주소처럼 서브넷팅할 수 있다.
  
  - B클래스에 속하지만, 네트워크 ID 영역이 24비트까지 늘어나고 호스트 ID 영역이 8비트로 축소되는 효과가 나타난다.

- 마찬가지로, C클래스 IP에 대해서도 디폴트 서브넷 마스크가 아닌 `255.255.255.248` 같이 **커스텀된** 서브넷 마스크를 적용한 서브넷팅이 가능하다.
  
  - 이는 네트워크 ID가 **29비트**까지 늘어나는 효과를 내고, 해당 서브넷 네트워크에 연결 가능한 호스트 IP 개수는 **8개**에 불과하다.

- 즉, **서브넷 마스크**의 목표는 궁극적으로 **네트워크 영역을 늘리고 호스트 영역을 줄이는** 데에 있다.
  
  - 이를 통해 네트워크 혼잡을 줄이고, IP 주소를 절약한다.

**서브넷 마스크를 통해** 분리된 하나의 **서브넷 네트워크**는 독립된 네트워크에 해당하고, 서브넷 네트워크 간에는 **라우터**를 통한 통신이 이루어져야 한다.

**프리픽스 표기법**을 적용해 서브넷 마스크를 표기할 수도 있는데, **네트워크 ID가 몇 비트까지 해당하는지**를 표시하면 된다.

- 특정 IP의 서브넷 마스크가 `255.255.255.248`이라는 내용을, (**29비트**짜리 서브넷 네트워크)

- IP 주소 뒤에 `/29` 라고 붙여서 표시함으로써 동일하게 나타낼 수 있다.

---

## 라우터의 구조

> 서로 다른 네트워크와 통신하려면 라우터가 필요하다.

### 라우터란?

서로 다른 네트워크와 통신하려면 라우터가 필요하다.

라우터는, **네트워크를 분리**할 수 있다.

- 라우터를 기점으로 그 밑에 **서로 다른 네트워크가 여러 개** 생겨날 수 있다는 것.

- 반면 **스위치**(L2)를 기점으로 그 밑에 연결된 **모든** 네트워크는 **동일한 네트워크** 안에 속하게 된다.

- **허브**도 마찬가지로 네트워크 분리가 불가능하다.

라우터를 통해 네트워크를 분할한 이후에는, 컴퓨터가 **다른 네트워크에 접속**할 방법이 필요하다.

이를 위해, **라우터의 IP 주소**를 먼저 설정해야 한다. 라우터에 연결된 네트워크의 **출입구**를 설정하는 실질이 있으므로, 이것을 **기본 게이트웨이**(default gateway)라고 한다.

- 컴퓨터가 다른 네트워크로 데이터를 보낼 때, 일단 **네트워크의 출입구**에 해당하는 **라우터**로 데이터를 전송한다. 

- 송신 측 컴퓨터의 기본 게이트웨이 설정에 더해, **라우팅**이 이루어져야 데이터 전송이 가능하다.

### 라우팅이란?

**라우팅**은, **경로 정보**를 기반으로 현재의 네트워크에서 다른 네트워크로 **최적의 경로를 통해 데이터를 전송**하는 것이다.

- 목적지에 도달하기 위해 거쳐야 할 **다음 라우터가 어딘지**를 경로 정보라고 볼 수 있다.

이러한 경로 정보가 등록된 테이블을 **라우팅 테이블**이라 한다.

- 각 라우터에는 경로 정보가 등록되어, 라우팅을 가능하게 한다.

- 라우팅 테이블 등록은 **수동**과 **자동**이 모두 가능한데, 대규모 네트워크라면 자동으로 등록하는 게 적합하다. 테이블 정보 수정도 자주 발생하기 때문.
  
  - 수정 사안에 대해, 자동 등록 시 **라우터 간의 경로 정보 교환**을 통해 라우팅 테이블 정보를 자동으로 수정하는 게 가능하다.
  
  - 라우터 간의 **라우팅 정보 교환을 위한 프로토콜**을 **라우팅 프로토콜**이라 한다.
  
  - 대표적인 프로토콜로는 RIP, OSPF, BGP 등이 있다.
