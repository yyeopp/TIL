# Chapter 08: 멀티호스트 환경에서 Docker 실행 환경 구축

---

## 멀티호스트 환경에서 컨테이너 관리의 개요

웹 시스템의 실행 환경은 웹 서버, 프록시 서버, 데이터 스토어 등 여러 서버 기능이 연계하여 작동된다.

또한, 제품 환경에서는 여러 개의 물리 서버나 가상머신으로 구성된 **멀티호스트** 환경을 조성하는 것이 일반적이다.

### 멀티호스트 환경과 클러스터링

지금까지는 동일 호스트 상에 몇 개의 컨테이너를 가동시켜 서버를 작동시켰다.

여러 개의 컨테이너를 일원 관리하기 위해 Docker Compose를 활용해본 정도.

**호스트에 장애가 발생할 경우** 이러한 서비스는 정지될 수밖에 없다.

- 그래서, 시스템 일부에서 장애가 발생하더라도 서비스 전체가 정지되지 않도록 하는 장치가 필요하다.

- 그 중 하나가 **클러스터링**. 여러 대의 서버나 하드웨어를 **모아서 한 대처럼 보이게 하는** 기술이다.
  
  - **가용성**(Availability)이 향상된다. 
    
    - 가용성은 시스템이 계속해서 가동될 수 있는 능력으로, 서버 오류나 하드웨어 고장이 발생해도 **다른** 정상적인 서버, 하드웨어가 대신 처리를 계속해줌으로써 높은 신뢰성을 제공한다.
  
  - **확장성**(Scalability)이 향상된다. 
    
    - 고부하로 인한 시스템 다운을 막기 위해, 여러 대의 컴퓨터를 클러스터화하여 **처리를 분산시킴**으로써 높은 처리 성능을 얻을 수 있다.

Docker를 활용하여, 여러 대의 호스트 머신 상에서 높은 가용성과 확장성을 가진 어플리케이션 실행 환경을 구축할 수 있다.

멀티호스트 환경에서 컨테이너 클러스터링을 수행하기 위한 툴을, **컨테이너 오케스트레이션 툴**이라고 한다.

멀티호스트 환경에서 컨테이너 장애나 호스트 머신 가동 상황 등을 감시하는 **통합 감시 툴**이나 클라우드에 의한 감시 서비스 또한 Docker를 통해 지원되고 있다.

### Docker Machine이란?

호스트 머신, 클라우드, 가상환경 등에 Docker 실행 환경을 만들 수 있는 **CLI** 툴이다.

- GCP, AWS, 온프레미스 환경 등 Docker Machine에 명령을 내리는 것 하나로 실행 환경을 구축할 수 있다.

---

## Docker Machine을 사용한 실행 환경 구축

### Docker Machine의 기본 명령

### 실행 환경 작성 (create)

`docker-machine create --driver <드라이버명> <작성할 Docker 머신명>`

`--driver`로 어떤 클라우드 / 가상머신에 실행 환경을 구축할 지 지정한다.

- 어떤 클라우드를 지정하는 지에 따라 create와 함께 이용할 수 있는 옵션이 달라진다.

### 실행 환경 목록 표시 (ls/status/url)

Docker Machine이 관리하는 실행 환경의 목록을 표시한다.

`docker-machine ls [옵션]`

같은 방법으로 머신의 스테이터스나 URL을 확인할 수 있다.

### 실행 환경에 대한 SSH 연결 (ssh)

`docker-machine ssh 머신명`

Docker Machine에서 작성한 실행 환경에 SSH로 연결한다.

### 실행 환경 시작/정지/재시작 (start/stop/restart)

### 실행 환경으로부터 파일 다운로드 (scp)

실행 환경 안의 파일을 다운로드한다.

> #### SCP
> 
> SSH의 기능을 사용하여 파일을 전송하기 위한 명령.
> 
> SCP에서 사용하는 통신 프로토콜은 Secure Copy Protocol이다. 인증 정보와 데이터를 암호화하여 네트워크로 전송한다.

### 실행 환경 삭제 (rm/kill)

### 실행 환경 정보 확인 (ip/inspect)

작성한 실행 환경의 IP 주소를 확인할 수 있다.

메모리나 CPU 같은 구성의 상세 정보를 확인할 수 있다.

> #### Mackerel을 사용한 Docker 감시
> 
> 서버 감시용 SaaS로, 클라우드 상 서버 감시에 친화성이 높고, 감시 대상에 에이전트를 설치하기만 하면 손쉽게 감시할 수 있다.
> 
> 에이전트로부터 수집한 데이터를 바탕으로, 리소스 이용 상황을 그래프로 표시하거나 장애 감지 시 알람을 송신하는 기능 등이 풍부하다.
> 
> Docker를 감시할 수 있는 mackerel-plugin-docker가 제공되고 있어, Docker 컨테이너의 CPU 사용률, 메모리 소비량, IO 사용량을 그래프로 간단히 확인할 수도 있다.

> #### 분산 시스템에서의 컨테이너 디자인 패턴
> 
> 클라우드를 사용해 Docker 실행 환경을 구축할 때는, 오케스트레이션 툴 외에도 소스코드 관리, Docker 이미지 리포지토리, 로깅 등 여러 서비스를 조합하게 된다.
> 
> 온프레미스라면 물리적인 작업과 초기 비용이 필요하기 때문에 사전에 상세한 설계가 필요하지만, 클라우드를 사용 중이라면 서비스 조합만으로 빠르게 시스템 구축이 가능하다.
> 
> **클라우드만의 설계 포인트**를 잘 살릴 필요가 있는데, 클라우드 서비스를 어떻게 조합할 지, 어떤 스토리지 서비스를 고를지 등이다.
> 
> 이렇게 **클라우드의 특성**을 고려해 장점을 최대한 살리는 형태로 구축된 아키텍처를 **클라우드 네이티브 아키텍처**라고 한다.
> 
> - 클라우드 네이티브 아키텍처를 실현하려면, 클라우드가 제공하는 요소 기술의 기초 이해는 물론 제공되는 서비스에 대한 지식, 실제 시스템에서의 적용 능력 등이 필요하다.
> 
> Docker의 경우 대규모 분산 환경에서 수평 스케일, 어플리케이션 이식성에 강점을 가진 툴로 클라우드와의 친화성이 높다.
> 
> - 분산 시스템에서 컨테이너를 사용해 어플리케이션을 실행하기 위한 **디자인 패턴**에 대해서는 따로 공부해보면 좋을 것이다.


