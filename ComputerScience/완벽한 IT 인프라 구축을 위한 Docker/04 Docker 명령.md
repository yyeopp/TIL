# Chatper 04: Docker 명령

---

Docker 이미지를 레지스트리에서 다운로드/업로드, Docker 컨테이너 시작/정지하는 등의 조작은 모두 명령어로 작동한다.

---

## Docker 이미지 조작

Docker의 공식 레지스트리 서비스인 Docker Hub에서 공개 이미지를 취득하는 방법

### Docker Hub

Github 같은 소스코드 관리 툴과 연계해 코드를 빌드하는 기능과, 실행 가능한 어플리케이션의 이미지를 관리하는 기능을 갖춘 Docker 공식 리포지토리 서비스.

도커 허브를 사용해 물리 서버, 가상 머신, 클라우드 어디든 Docker 이미지 배포가 가능하다.

- Debian 같은 공식 이미지는 Official 표시가 붙어 있다.

이미지 버전 관리는 **태그**로 이루어지는데, 이미지명 옆에 `:태그명`을 붙이는 식이다.

- `latest`를 붙이면 공개된 버전 중 가장 최신 이미지를 가르킨다.

> #### Docker store
> 
> Docker사가 제공하는 소프트웨어 마켓 플레이스.
> 
> 멀웨어 테스트 등을 모두 통과하고 서명된 것을 배포한다.
> 
> 요금 부과, 라이선스 관리 장치도 가지고 있어서 많은 상용 소프트웨어가 참여 중이다.

### 이미지 다운로드

`docker image pull [옵션] 이미지명:[태그명]`

- `-a` 옵션을 넣으면 **모든 태그**의 이미지를 취득할 수 있다.

- 이미지명에 이미지를 취득할 수 있는 **URL**을 넣을 수도 있다.

### 이미지 목록 표시

`docker image ls [옵션] [리포지토리명]`

Docker 이미지는 작성 시 고유 ID가 부여되고, ls 명령 시 표시된다.

Docker 레지스트리에 업로드한 이미지는 고유 식별값으로서 **다이제스트**가 부여되는데, `--digests`를 옵션으로 넣으면 확인 가능하다.

> #### 이미지의 위장이나 변조를 막으려면
> 
> Docker에는 **인프라 구성**이 포함되기 때문에, 제3자의 악의적인 변조로부터 보호할 필요가 있다.
> 
> 이 때 **Docker Content Trust**(DCT) 기능을 사용해 이미지의 정당성을 확인할 수 있다.
> 
> ##### 서명
> 
> 이미지 작성자가 Docker 레지스트리에 이미지를 push하기 전에, **로컬 환경**에서 이미지 작성자의 **비밀키**를 사용해 이미지에 서명한다.
> 
> - 이 비밀키를 **Offline Key**라고 하는데, 보안상 매우 중요한 키이므로 엄중하게 관리해야 한다.
> 
> ##### 검증
> 
> 서명된 이미지를 pull할 때, 이미지 작성자의 **공개키**를 사용해 이미지가 진짜인지 확인한다.
> 
> 만약 변조된 경우 해당 이미지는 **무효화**된다.
> 
> - 이 공개키를 **Tagging Key**라고 한다.
> 
> ##### 기능 사용
> 
> `export DOCKER_CONTENT_TRUST=1`로 DCT 기능을 유효화할 수 있다.
> 
> 유효화 이후부터는, pull할 때 이미지 검증 절차가 추가되는 것을 볼 수 있다.

### 이미지 상세 정보 확인

`docker image inspect`

이미지 ID, 작성일, Docker 버전, CPU 아키텍처 등이 표시된다.

### 이미지 태그 설정

태그는 이미지의 표식이 된다. 보통 식별하기 쉬운 **버전명**을 붙인다.

Docker Hub에 업로드할 때는,

`<Docker Hub 사용자명>/이미지명:[태그명]`의 규칙으로 업로드가 이루어진다.

### 이미지 검색

`docker search [옵션] <검색 키워드>`

Docker Hub에 공개되어 있는 이미지를 검색할 수 있다.

- 검색 결과에서 Official 여부, Stars(즐겨찾기 수)를 확인할 수 있다.

### 이미지 삭제

`docker image rm [옵션] 이미지명 [이미지명]`

실행 시, 중간 이미지도 함께 삭제된다.

사용하지 않는 Docker 이미지를 삭제할 때에는

`docker image prune [옵션]`을 사용한다.

- 사용하지 않는 이미지는 디스크 용량을 쓸데없이 잡아먹기 때문에, 정기적으로 삭제하는 것이 좋다.

### Docker Hub에 로그인

`docker login [옵션] [서버]`

Docker 리포지토리에 업로드하기 위해 필요하다.

서버명을 별도로 지정하지 않으면 Docker Hub에 엑세스하는 식이다.

### 이미지 업로드

`docker image push 이미지명[:태그명]`

등록된 이미지는

`<Docker Hub 사용자명>/이미지명:[태그명]` 으로 표시된다.

### Docker Hub에서 로그아웃

`docker logout [서버명]`

---

## Docker 컨테이너 생성 / 시작 / 정지

### Docker 컨테이너의 라이프 사이클

#### 컨테이너 생성

`docker container create`

이미지에서 컨테이너를 생성한다.

이미지의 실체는, **Docker에서 서버 기능을 작동시키기 위해 필요한 디렉토리 및 파일들**이다.

- Linux 작동에 필요한 /etc나 /bin 등이 포함되어 있다.

create 명령 실행 시 이미지에 포함될 Linux 디렉토리와 파일들의 **스냅샷**을 취하게 된다.

- 스냅샷은, 스토리지 안에 존재하는 파일과 디렉토리를 **특정 타이밍에 추출한 것**을 말한다.

#### 컨테이너 생성 및 시작

`docker container run`

이미지로부터 컨테이너를 생성하고(create), 그 위에서 프로세스를 시작한다.

포트 번호 같은 네트워크 설정을 포함시켜, 외부에서 컨테이너에 프로세스에 엑세스할 수 있도록 할 수도 있다.

#### 컨테이너 시작

`docker container start`

**정지 중인** 컨테이너를 시작할 때 사용한다.

#### 컨테이너 정지

`docker container stop`

실행 중인 컨테이너를 정지시킬 때 사용한다.

컨테이너 삭제를 위해서는 stop 명령이 선행되어야 한다.

컨테이너 재시작에는 `restart` 명령을 사용하면 된다.

#### 컨테이너 삭제

`docker container rm`

정지 중인 컨테이너 프로세스를 삭제해, **스냅샷을 소멸**시킨다.

#### 그 외

컨테이너 상태를 확인하는 `docker container ps`

컨테이너를 일시정지하는 `docker container pause` 등이 있다.

### 컨테이너 생성 및 시작

`docker container run [옵션] 이미지명[:태그명] [인수]`

옵션 값을 어떻게 지정하는 지가 중요하다.

- `-it` 를 주면 컨테이너의 표준 출력을 찍어낼 수 있다.

- `--name`으로 컨테이너 이름을 지정할 수 있다.

> #### 프롬프트
> 
> **명령을 입력할 수 있는 표시**를 말한다.
> 
> `docker@default:~$` 이런 식으로 뜨는데,
> 
> - docker는 사용자명
> 
> - default는 호스트명
> 
> - ~는 작업 디렉토리
>   
>   - Linux의 경로가 표시된다. ~는 사용자의 홈 디렉토리.
> 
> - $는 사용자의 권한
>   
>   - 일반 사용자는 $이고, 관리자는 #로 표시된다.
> 
> `sudo su`로 관리자 계정으로 접속하면 프롬프트 표시가 바뀐다.

### 컨테이너의 백그라운드 실행

run 시 `-d` 옵션을 넣어주면 백그라운드 실행이 가능하다.

실행 중인 컨테이너의 로그는 `docker container logs`로 확인 가능하다.

백그라운드 실행 시 restart나 rm 같은 명령을 부가할 수도 있다.

### 컨테이너의 네트워크 설정

run 시 **네트워크 관련 옵션**을 넣어줄 수 있다.

`-p`는 컨테이너의 포트 번호와 호스트 OS의 포트 번호를 매핑할 때 사용된다.

- 지정된 범위 내에서 포트 번호를 할당하고 싶으면 `--expose`를,

- 호스트 OS에 **임의의 포트를 할당**하고 싶으면 `-P`를 사용한다.

**DNS 서버를 설정**할 때는 `--dns`에 IP주소를 지정한다.

**MAC 주소를 설정**할 때는 `--mac-address`를 지정한다.

컨테이너 안에서 직접 호스트명과 IP 주소를 정의하려면, `--add-host`를 사용한다.

Docker는 기본적으로 호스트 OS에 **브리지 연결**을 하는데, `--net` 옵션을 사용해 그 외의 설정이 가능하다.

- `--net=[NETWORK]`는 **사용자 정의 네트워크**를 사용하겠다는 뜻.

- `docker network create`를 이용해 사용자 정의 네트워크를 만들 수 있는데, Docker 네트워크 드라이버 또는 외부 네트워크 드라이버 플러그인을 사용해 만든다.
  
  - 똑같은 네트워크에 여러 컨테이너가 연결 가능하므로,
  
  - 사용자 정의 네트워크에 연결된 여러 컨테이너들은 서로 통신이 가능하다.

- 오버레이 네트워크나 커스텀 플러그인을 사용하면 **멀티호스트** 연결도 가능하다.
  
  - 컨테이너들이 동일한 멀티호스트 네트워크에 연결되어 있으면, 해당 네트워크를 통해 서로 통신할 수 있다.

### 자원을 지정하여 컨테이너 생성 및 실행

run 시 옵션을 넣어, CPU나 메모리 등 자원을 지정해 컨테이너를 생성 및 실행할 수 있다.

- `-c`로 CPU 사용 배분을 정하는데, 기본이 1024이므로 그에 맞춰 조정 가능하다.

- `-m`으로 메모리 제한을 걸 수 있다.

호스트 OS와 컨테이너 안의 디렉토리를 **공유**할 때는 `-v`를 지정한다.

### 컨테이너를 생성 및 시작하는 환경을 지정

run 시 컨테이너의 환경변수와 컨테이너 안 작업 디렉토리를 지정할 수 있다.

- `-e`에 환경변수들을 직접 정의할 수 있고,

- `--env-file=[파일명]`으로 파일로부터 환경변수 설정이 가능하다.

- `-w=[패스]`로 컨테이너의 작업 디렉토리를 설정한다.

### 가동 컨테이너 목록 표시

`docker container ls [옵션]`

- 컨테이너 ID를 비롯한 정보 확인이 가능하다.

- `-a` 옵션을 주면 정지 중인 컨테이너도 표시된다.

### 컨테이너 가동 확인

`docker container stats [컨테이너 식별자]`

이 위에서 실행 중인 프로세스를 확인할 때는, `docker container top [컨테이너명]`을 쓴다.

### 컨테이너 시작

`docker container start [옵션] <컨테이너 식별자> [컨테이너 식별자]`

### 컨테이너 정지

`docker container stop [옵션] <컨테이너 식별자> [컨테이너 식별자]`

- `-t` 옵션을 줘서 정지 시간을 설정할 수 있다.

- `kill` 명령은 강제 정지다.

### 컨테이너 재시작

`docker container restart [옵션] <컨테이너 식별자> [컨테이너 식별자]`

정지 시간 설정 가능하다.

> #### Linux 명령을 모르면 안 되는가?
> 
> Linux 또한 GUI가 가능하지만, 서버용으로 사용한다면 대부분 CLI를 사용한다.
> 
> 그 이유는,
> 
> - **네트워크를 통해 조작**할 수 있다.
> 
> - 정형 작업을 프로그래밍으로 **자동화**할 수 있다.
> 
> 특히 클라우드 서비스는 서버가 데이터센터에 있고, 원격으로 조작하므로 터미널 단말기 선에서 네트워크를 통해 조작할 수 있는 CLI가 편리하다.
> 
> 시스템 운용을 자동화하는 측면에서도 CLI가 유리하다.

### 컨테이너 삭제

`docker container rm [옵션] <컨테이너 식별자> [컨테이너 식별자]`

정지 중인 모든 컨테이너를 삭제하려면 `docker container prune`을 쓴다.

### 컨테이너 중단 / 재개

`docker container pause <컨테이너 식별자>`

`docker container unpause <컨테이너 식별자>`

---

## Docker 컨테이너 네트워크


