# 스프링과 문제 해결 - 트랜잭션

---

## 문제점들

### 애플리케이션 구조

가장 일반적인 애플리케이션 구조는 다음과 같다.

- 프레젠테이션 계층
  
  - `@Controller`
  
  - UI 관련 처리 담당
  
  - 웹 요청과 응답
  
  - 사용자 요청 검증
  
  - 주로 서블릿, HTTP 같은 웹 기술이나 스프링 MVC 사용

- 서비스 계층
  
  - `@Service`
  
  - 비즈니스 로직을 담당
  
  - 순수 자바 코드

- 데이터 접근 계층
  
  - `@Repository`
  
  - 실제 데이터베이스에 접근하는 코드
  
  - JDBC, JPA, File, Redis, MongoDB 등

### 순수한 서비스 계층?

가장 중요한 곳은? **서비스 계층**이다.

UI 디자인이 변화하고, 데이터 저장 기술이 변화해도 **비즈니스 로직**은 최대한 변화하지 않아야 한다.

그러려면 서비스 계층을 **특정 기술에 종속적이지 않게** 개발할 필요가 있다.

- 기술 종속적인 부분은 나머지 계층에서 최대한 가지고 간다.
  
  - 프레젠테이션 계층에서 UI 관련 기술의 변화를 다 커버해주고,
  
  - 데이터 접근 계층에서 데이터 접근 기술의 변화를 커버해주도록.
    
    - 서비스 계층이 데이터에 직접 접근하는 게 아니라, 데이터 접근 계층에서 **제공하는 인터페이스**에만 의존하도록 구성

- 서비스 계층이 기술 독립적일 때, **유지보수**하기도 쉽고 **테스트**도 쉽다.

- 향후 구현 기술이 변경될 때 **영향도**도 최소화할 수 있다.

### 문제점들

지금까지 실습하면서 작성한 코드의 문제점은 무엇일까?

- (특히 트랜잭션을 적용한 코드에서) **서비스 로직이 JDBC 기술에 지나치게 종속적이다.**
  
  - 결과적으로 비즈니스 로직보다도 트랜잭션 처리 코드가 더 많다.
  
  - 데이터 접근 기술이 JDBC에서 다른 것으로 변경되면 비즈니스 로직은 모두 재개발 대상

**정리하면**, 아래와 같이 3가지.

- 트랜잭션 문제

- 예외 누수 문제

- JDBC 반복 문제

#### 트랜잭션 문제

##### JDBC 구현 기술이 서비스 계층에 누수되는 문제

구현 기술을 변경해도 **서비스 계층 코드를 최대한 유지**할 수 있어야 하는데,

**트랜잭션 구현하느라** JDBC 코드가 서비스 계층으로 와장창 쏟아진 모습

##### 트랜잭션 동기화 문제

같은 트랜잭션을 유지하기 위해 커넥션을 파라미터로 넘겨야 한다.

개발 단계에서 혼동의 여지가 매우 크다.

##### 트랜잭션 적용 반복 문제

서비스 계층에서 Connection을 생성하고 release 하는 try - catch - finally 코드가 계속 반복된다.

#### 예외 누수

데이터 접근 계층의 JDBC 예외가, 서비스 계층으로 전파된다.

서비스 계층에서 `SQLException`을 잡든가 던져야하는데, 해당 예외는 JDBC 고유 Exception이므로 서비스 계층의 유지보수성이 떨어진다.

#### JDBC 반복 문제

`MemberRepository` 코드는 순수한 JDBC를 사용해서 만들었는데, 유사한 코드의 반복이 무척 많다.

---

## 트랜잭션 추상화


