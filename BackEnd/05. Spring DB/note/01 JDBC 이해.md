# JDBC 이해

---

## JDBC 이해

### 애플리케이션 서버와 DB

애플리케이션 개발 시 데이터는 대부분 데이터베이스를 사용해 보관한다.

클라이언트가 요청을 보냈을 때 애플리케이션 서버는,

1. TCP/IP 를 사용해서 DB와 **커넥션**을 연결

2. 애플리케이션 서버가 SQL을 DB에 전달

3. DB는 SQL을 수행해서 서버로 결과를 전달

#### DB 변경 시?

과거에는 각각의 데이터베이스마다 커넥션 연결 방법, SQL 전달 방법 등이 모두 달랐다.

- DB를 변경하려면 애플리케이션 서버의 코드까지 함께 바꿔야하는 것.

- 개발자는 그에 대해 모두 학습해야 함.

### JDBC 표준 인터페이스

위와 같은 문제를 해결하기 위한 **자바 표준**.

JDBC는 Java에서 데이터베이스를 접속할 수 있도록 하는 자바 API다.

- `java.sql.Connection` : 연결

- `java.sql.Statement` : SQL을 담은 내용

- `java.sql.ResultSet` : SQL 요청 응답

위와 같은 표준 인터페이스를 **추상화**시켜뒀고, 개발자는 이것만 사용해서 개발한다.

- 해당 JDBC 인터페이스에 대한 구현체는 각각의 DB 벤더사에서 개발하여 라이브러리로 제공하게 된다.
  
  - **JDBC 드라이버** 라고 한다.

- 흔히 사용하는 MySQL도 **MySQL JDBC 드라이버**를 제공하고 있다.

#### JDBC가 해결한 문제점

- DB 변경 시 WAS의 DB 코드를 함께 변경해야했던 문제
  
  - WAS의 로직은 이제 JDBC 표준 인터페이스에만 의존하면 된다.

- 개발자가 모든 DB의 커넥션 연결 / SQL 전달 / 응답받는 방법을 학습해서 사용해야했던 문제
  
  - JDBC 표준 인터페이스만 학습하면 된다.

> #### 표준화의 한계
> 
> 여전히 각각의 DB마다 일부 사용법이 다른 상태. 특히 가장 대표적인 게 **SQL** 부분
> 
> **ANSI SQL**이라는 표준으로 공통화된 부분이 있기는 하나나, 여전히 실무적으로 활용하는 DB 종류마다 고유의 SQL을 들고 있다.
> 
> - 대표적인 게 **페이징 SQL**
> 
> JPA를 활용하면 이 부분도 조금 나아질 수 있다.

---

## JDBC와 최신 데이터 접근 기술

JDBC는 1997년생. 보통 직접 사용하기보다 이걸 더 편리하게 말아서 사용하고 있다.

### JDBC 직접 사용하는 경우

애플리케이션 로직 상에서 SQL을 한 줄씩 생성해서, JDBC를 통해 SQL를 전달

### SQL Mapper

애플리케이션 로직이 SQL Mapper로 SQL 로직을 전달하면, Mapper가 많은 부분을 자동화하여 JDBC로 전달해준다.

- 장점: JDBC 사용이 훨씬 편리하다. 각종 반복적인 코드가 제거됨

- 단점: 개발자가 직접 SQL을 작성해야 함.

- 대표 기술: 스프링 JdbcTemplate, **Mybatis**

### ORM 기술

ORM은 **객체를 관계형 데이터베이스 테이블과 매핑해주는 기술**이다. 

- 애플리케이션 로직이 JPA로 **객체**를 전달하면, **JPA 구현체**(하이버네이트 등)가 SQL을 생성해서 JDBC로 전달해준다.

개발자가 반복적인 SQL을 직접 작성하지 않아도, ORM이 SQL을 동적으로 만들어서 실행해준다.

각 DB마다 SQL 문법이 다른 점도 일부 해결해줄 수 있다.

- 대표 기술: **JPA**, 하이버네이크, 이클립스링크

- JPA가 자바 진영의 ORM 표준 인터페이스.

### SQL Mapper vs ORM

Mapper는 **SQL만 직접 작성할 줄 알면** 아주 금방 배워서 사용할 수 있다.

ORM은 SQL을 직접 작성하지 않기 때문에 개발 생산성이 매우 높지만, **어렵다.** 실무에서 사용하려면 많은 학습이 필요하다.

> #### 중요 : 결국에는 JDBC
> 
> 모든 기술들은 내부적으로 모두 **JDBC**를 사용한다.
> 
> JDBC가 어떻게 동작하는지, 기본 원리를 정확히 알고 있어야 **문제가 발생했을 때** 근본적인 원인을 찾아 해결할 수 있다.
> 
> **JDBC는 자바 개발자라면 꼭 알아두어야 하는 필수 기술**

---

## 데이터베이스 연결

> H2 데이터베이스를 켜둔 상태로, `Connection` 인터페이스를 반환하는 `DBConnectionUtil.getConnection()` 메서드를 테스트한다.

### 실행 결과

`Connection` 은 인터페이스이고, 반환되는 **구현체**는 `class = class org.h2.jdbc.JdbcConnection` 로 표시된다.

즉, 앞서 나온 바와 같이 **JDBC 드라이버**를 **H2** 측에서 구현해둔 객체에 해당한다.

- External Liberaries 에서 H2가 구현해둔 JDBC 드라이버의 상세코드를 확인할 수 있다.

### DriverManager 커넥션 요청 흐름

- JDBC가 제공하는 `DriverManager`는 라이브러리에 등록된 DB 드라이버들을 관리하고, 커넥션을 획득하는 역할이다.
  
  - 애플리케이션 로직에서 커넥션이 필요할 때, `DriverManager.getConnection()` 으로 DB 커넥션을 획득하게 된다.

- `DriverManager`는 External Libraries로 등록된 드라이버 목록을 자동으로 인식한다. 
  
  - 드라이버들에게 순서대로 정보를 넘겨서, 커넥션을 획득할 수 있는지 확인한다.

- 전달하는 정보는 아래와 같다.
  
  - URL : `jdbc:h2: ~~`
  
  - 이름, 비밀번호 등 추가 정보

- 각 드라이버는 **URL**을 기반으로 본인이 처리할 수 있는 요청인지 확인한다.

- 처리 가능한 요청이면 실제 DB에 연결해서 커넥션을 획득하고, DriverManager에게 리턴한다.
  
  - 물론 그 커넥션은 `java.sql.Connection` 인터페이스가 구현되어 있는 객체

---

## JDBC 개발 - 등록

순수 JDBC를 사용해서 회원 데이터를 DB에 등록는 기능을 개발하기

### 요약

1. DriverManager에서 Connection 획득하는 과정에서 예외처리

2. `Statement` 클래스를 이용한 SQL 입력 및 execute 처리
   
   - `PreparedStatement` 클래스를 이용한 파라미터 바인딩 처리와 **SQL Injection** 공격 예방

3. 리소스 정리하기 - `finally` 구문에서 `close()` 처리
   
   - **리소스 누수** 방지

---

## JDBC 개발 - 조회

### 요약

1. `ResultSet`을 이용해서 select 결과를 받아내기
   
   - `rs.next()` 의 사용법 숙지

2. 테스트코드 상에서 insert된 객체와 select된 객체가 동일하다고 잡히는 이유
   
   - `lombok`에서 `@EqualsAndHashCode` 구현해준 덕분

### ResultSet

`ResultSet`은 DB 테이블과 동일하게 생긴 데이터 구조로, select 쿼리의 결과가 순서대로 들어간다.

`ResultSet` 내부에는 `cursor` 가 있어서, 이동하면서 데이터를 조회하고 있다.

커서는 최초에 데이터를 가지고 있지 않으므로, 애플리케이션 로직에서 `rs.next()` 를 한 번은 호출해야 한다.

- `rs.next()` 했을 때 `false` 가 돌아오면 조회 결과가 없는 것.

- 즉, **다행 조회가 가능한 쿼리인 경우** 처음 한 번은 기본으로 호출하고, 그 뒤에는 `false`가 나올 때까지 호출하기

---

## JDBC 개발 - 수정, 삭제

insert 처리와 거의 동일하다.

### 요약

1. delete 쿼리에 대한 테스트코드 작성 방법
   
   - `NoSuchElementException`을 `assertThatThrownBy` 코드로 잡기

2. 반복 실행 가능한 테스트코드 작성 방법
   
   - insert로 시작해서 delete 로 끝나기 때문에 계속 실행할 수 있다.
   
   - 하지만 좋은 방법이 아니라는 점 - 중간에 Exception이 발생한다면?
   
   - **트랜잭션** 활용 필요


