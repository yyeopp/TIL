# 스프링 AOP 개념

---

## AOP 소개 - 핵심 기능과 부가 기능

애플리케이션 로직은 크게 **핵심 기능**과 **부가 기능**으로 나눌 수 있다.

- 핵심 기능은 **해당 객체가 제공하는 고유의 기능**이다.

- 부가 기능은 **핵심 기능을 보조하기 위해 제공되는 기능**이다.
  
  - 대표적으로 로그 추적, 트랜잭션 등이 이에 해당한다.
  
  - 단독으로 사용되지 않고, 핵심 기능을 보조하기 위해 존재한다.

### 여러 곳에서 공통으로 사용하는 부가 기능

보통, 부가 기능은 **여러 클래스에 걸쳐서 동일하게 사용**되는 특성을 가지고 있다.

이러한 부가 기능은 **횡단 관심사**라고 할 수 있으며, **핵심 기능에서 최대한 분리하여 공통적으로 해결**하는 것이 중요하다.

- 부가 기능이 필요하다고 해서 모든 핵심 기능에서 동일한 코드를 넣는다거나,

- 별도 유틸리티 클래스를 만들어서 호출하도록 하는 것은

- **부가 기능 적용 과정에서** 핵심 기능 코드에 리스크를 유발하며, **변경**을 극히 어렵게 만든다.

#### 부가 기능 적용 문제 정리

- 부가 기능 적용을 위해 아주 많은 **반복**이 필요하다.

- 부가 기능이 여러 곳에 퍼져서 **중복 코드**를 만들어낸다.

- 부가 기능 **변경** 시 많은 수정이 필요하다.

- 부가 기능의 **적용 대상을 변경**할 시 많은 수정이 필요하다.

즉, 이러한 부가 기능의 경우 **일반적인 OOP 방식으로는 해결이 어렵기 때문에,** 다른 관점이 적용될 필요가 있다.

---

## AOP 소개 - 애스펙트

### 핵심 기능과 부가 기능을 분리

이렇게 **부가 기능 그 자체와, 부가 기능을 어디에 적용할지 선택하는 기능**을 합쳐서 하나의 모듈로 만든 것이 바로 **Aspect**이다.

- 지금까지 사용한 `@Aspect`가 이러한 기반에서 만들어진 것.

- 스프링이 제공하는 어드바이저는 **개념적으로 하나의 Aspect**가 되는 것.

Aspect는, **애플리케이션을 바라보는 관점을 하나하나의 기능에서 횡단 관심사 관점으로 달리 보는 것**이다.

그리고 Aspect를 사용한 **프로그래밍 방식**을 **관점 지향 프로그래밍, AOP**라고 한다.

- AOP는 OOP를 **대체**하기 위한 것이 아니다.

- OOP가 **횡단 관심사를 깔끔하게 처리하기 어렵다는 문제점**을 **보조하기 위한 목적**으로 개발되었다.

### AspectJ 프레임워크

AOP에 대한 **대표적인 구현체**를 제공하는 프레임워크이다.

스프링 AOP도 대부분 AspectJ의 **문법을 차용**하고 있다.

해당 프레임워크를 간단히 정리하면 아래와 같다.

- 자바 언어에 대한 관점 지향 확장

- 횡단 관심사의 깔끔한 모듈화
  
  - 오류 검사 및 처리
  
  - 동기화
  
  - 성능 최적화 (캐싱)
  
  - 모니터링 및 로깅

---

## AOP 적용 방식

AOP를 사용할 때 부가 기능 로직을 **어떤 방식으로 실제 로직에 추가할지**는 여러 방법이 있다.

- **컴파일 시점**

- **클래스 로딩 시점**

- **런타임 시점** (프록시)

### 컴파일 시점

java 소스를 컴파일러를 사용하여 class로 변환하는 시점에 **부가 기능** 로직을 추가하는 방법도 있기는 하다.

- 클래스 파일을 디컴파일해보면 부가 기능 코드가 붙어있는 모습을 확인 가능하다.

이런 식으로 원본 로직에 부가 기능이 추가되는 경우를 **위빙**(weaving)이라고 한다.

#### 단점

**특수한 컴파일러**를 사용해야 한다. (`AspectJ` 컴파일러)

다소 복잡한 방식이라고 할 수 있다.

### 클래스 로딩 시점

자바가 class 파일을 **JVM 내부 클래스 로더에 보관**하려 할 때, 그 중간에서 class 파일을 **조작한 다음 JVM에 올리는** 방식이다.

- `java Instrumentation` 이라는 기법.

- 수 많은 모니터링 툴들이 이 방식을 사용한다.

이 시점에 Aspect를 적용하는 것은 **로드 타임 위빙**이라고 한다.

#### 자바

자바 실행 시 특별한 옵션을 이용하여 **클래스 로더 조작기를 지정**해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.

### 런타임 시점

컴파일, 클래스 로딩이 모두 끝나고 **자바가 실행되고 난 이후**를 말한다. 메인 메서드도 이미 실행된 다음이다.

이 경우 스프링 같은 컨테이너나 프록시, DI, 빈 후처리기 등 **모든 개념을 총동원하여** 적용하게 된다.

- 지금까지 학습한 것이 바로 **런타임 시점**, **프록시 방식**의 AOP이다.

**프록시**를 사용하기 때문에 AOP 기능 상의 일부 제약이 존재하지만,

별도의 컴파일러라든지 클래스 로더 조작기를 설정하는 것이 아니라 **스프링만 있다면** AOP 적용이 가능하기 때문에 **개발자가 보다 범용적으로 사용 가능한** 방식이다.

- 앞 두 방식은 **실제 대상 코드가 변조**된다는 점이 핵심

---

## AOP 적용 위치

AOP는 사실 메서드 실행 위치 뿐만 아니라 다양한 위치에 적용될 수 있다.

- 적용 가능 지점을 **조인 포인트**라고 하는데, AOP는 개념상 메서드 실행 뿐만 아니라 **생성자나 필드 값 접근, static 메서드 접근** 모두에 적용 가능하다.

하지만, **프록시를 사용하는 스프링 AOP**이기 때문에 **메서드 실행 시점**에서만 AOP 적용이 가능해진 것.

- 기술적으로 당연한 얘기다. 생성자나 static 메서드까지 부가기능을 적용하려면 **대상 코드 변조가 물리적으로 반드시 필요**하다.

- 컴파일 혹은 클래스 로딩 시점에 AOP가 들어가야 한다.

프록시의 경우 기본적으로 **메서드 오버라이딩 개념**으로 동작한다.

- 즉, 프록시를 사용하는 스프링 AOP는 **조인 포인트가 메서드 실행 시점**으로 **제한**된다.

- 또한 **스프링 컨테이너가 관리할 수 있는 스프링 빈에만 적용** 가능하다.

#### 참고

스프링은 AspectJ의 문법을 차용했을 뿐이다. AspectJ를 직접 사용하는 것이 아니다.

### 중요

스프링이 제공하는 AOP는 **프록시**를 사용하기 때문에 **메서드 실행 시점**에만 AOP 적용이 가능하다고 했다.

- 그렇다는 건 AspectJ를 **직접 사용하는 것이 AOP 입장에서는 더 풍부한 기능을 적용**할 수 있다는 뜻

하지만 실무에서는 **스프링이 제공하는 AOP만 사용해도 거의 모든 문제를 해결**할 수 있기 때문에,

굳이 공부할 내용도 많고 다소 이질적인 AspectJ를 사용하지 않는 것이다.

- 별도 컴파일러, 별도 문법, 자바 실행 옵션 등을 따로 공부하고 분석해야 한다.

---

## AOP 용어 정리

### 조인 포인트 (Join Point)

**어드바이스가 적용될 수 있는 위치**

- 메서드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 등

**추상적인 개념**이다. AOP를 적용할 수 있는 모든 지점이다.

스프링 AOP의 경우 **프록시** 방식이기 때문에 **항상** 메서드 실행 시점이다.

### 포인트컷 (Pointcut)

여러 조인 포인트 중에서 **어드바이스가 적용될 위치를 선별**하는 기능.

주로 **AspectJ 표현식**을 사용해서 지정한다.

### 타겟 (Target)

**어드바이스를 받는 객체**.

- 부가기능을 적용할 핵심기능을 들고 있는 객체

**포인트컷**을 사용하여 결정한다.

### 어드바이스 (Advice)

**부가 기능**

특정 조인 포인트에서 **Aspect**에 의해 **취해지는 조치**

- Around, Before, After 같은 다양한 종류가 있다.

### 애스펙트 (Aspect)

**어드바이스 + 포인트컷**을 **모듈화** 한 것.

**개념적으로**, 하나의 애스펙트에 **여러** 어드바이스와 포인트컷이 함께 묶여있을 수 있다.

### 어드바이저 (Advisor)

**하나의** 어드바이스와 **하나**의 포인트 컷으로 구성된 **특수한 애스펙트**이다.

스프링 AOP에서만 사용되는 용어다.

### 위빙 (Weaving)

포인트컷으로 결정한 **타겟의 조인 포인트에 어드바이스를 적용하는 것**을 뜨한다.

위빙을 이용하여, 핵심 기능에 영향을 주지 않고 부가 기능을 추가할 수 있다.

### AOP 프록시

AOP 기능을 구현하기 위해 만든 **프록시 객체**로,

스프링의 경우 JDK 동적 프록시 또는 CGLIB 프록시를 사용 가능하다.


