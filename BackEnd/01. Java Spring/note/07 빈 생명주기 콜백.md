# 빈 생명주기 콜백

---

## 빈 생명주기 콜백

DB 커넥션 풀 로딩이나 네트워크 소켓 연결 같이, 애플리케이션 시작 시점에 **미리** 객체를 생성하고 종료 시점에 소멸시키는 루틴한 작업들이 많이 있다.

스프링이 이러한 객체의 **초기화와 종료** 작업을 어떻게 지원하는지 확인해본다.

### 예제 코드 요약

- `NetworkClient` 는 `url` 을 필드값으로 가진다. 애플리케이션 구동 시점에 해당 클래스를 빈으로 등록하면서, 지정된 url로 연결을 생성하는 것이 목적
  
  - 해당 객체가 **제 역할을 할 수 있게끔 완성시켜준다**는 점에서 이를 **초기화**라고 부를 수 있다.

- 해당 객체의 의존성이라고도 할 수 있는 `url` 값을 아무때나 `setter` 로 지정하면, 우리가 원하는 **초기화** 로직이 작동할 수 없다.
  
  - 객체 생성 이후 의존관계 주입이 마무리되기 전에 초기화 로직이 동작하게 된다.

### 스프링 빈 라이프사이클

스프링 빈은 결국, **객체 생성**과 **의존관계 주입**이 다 끝난 후에야 의미있는 초기화 작업을 수행할 수 있다.

그래서 스프링은, **의존관계 주입이 완료된 시점에 콜백 메서드를 이용해서 초기화 시점을 개발자에게 알려주는** 기능을 제공한다.

마찬가지로 스프링 컨테이너가 종료되기 직전에 **소멸 콜백**도 제공하고 있다.

#### 스프링 빈 이벤트 라이프사이클

- 스프링 컨테이너 생성

- 스프링 빈 생성

- 의존관계 주입

- 초기화 콜백
  
  - 빈 생성 후 의존관계 주입이 모두 완료된 시점

- 사용

- 소멸 전 콜백
  
  - 빈이 소멸되기 직전 시

- 스프링 종료

#### 객체의 생성과 초기화를 분리하자

위와 같은 문제를 해결하기 위해, **모든 초기화 작업을 생성자에서 진행한다**는 발상을 해볼 수는 있다. 근데 권장하지 않는다.

생성자는 필수 파라미터를 받아서 메모리를 할당하고 **객체를 생성**하는 데에 **책임**을 가진다.

반면 초기화 작업은 이렇게 생성된 객체를 이용해서 외부 커넥션 연결과 같은 **별도의 무거운 동작**을 수행한다.

이렇게 서로 다른 역할을 하나의 생성자에서 하는 것은 유지보수 관점에서 바람직하지 않다.

- 객체 내부 static 값들을 세팅하는 수준이라면 생성자에서 진행해도 괜찮다.

- **초기화 작업이 웬만큼 무겁다면, 객체 생성과 분리하는 게 바람직**하다.

---

## 인터페이스 InitializingBean, DisposableBean

앞선 예제 코드에서 발생한 문제점은, 빈 생명주기 콜백 함수를 지원하는 인터페이스들을 구현해 사용함으로써 해결 가능하다.

- `InitializingBean` 이 제공하는 `afterPropertiesSet()` 으로 초기화 처리

- `DisposableBean` 이 제공하는 `destroy()` 로 소멸 처리

### 초기화, 소멸 인터페이스 단점

**스프링 전용 인터페이스**이기 때문에, 해당 코드가 스프링에 완전히 의존하게 된다.

초기화, 소멸 메서드의 이름은 변경할 수 없다.

내가 코드를 고칠 수 없는 **외부 라이브러리**에서는 사용할 수 없다.

- 라이브러리 클래스에서 인터페이스 구현을 직접 선언할 수는 없다.

#### 사실..

이 방법은 스프링 초창기에서나 사용하던 방식이다.

현재는 더 나은 방법들이 있기 때문에 사용하지 않는다.

---

## 빈 등록 초기화, 소멸 메서드

`@Bean` 선언 시점에 `initMethod` 와 `destroryMethod` 를 지정해주는 방식.

### 설정 정보 사용 특징

init, destroy 메서드 이름을 자유롭게 사용할 수 있다.

**스프링 빈이 스프링 코드에 의존하지 않는다.**

외부 라이브러리라 하더라도 초기화, 종료 메서드를 적용할 수 있다.

### 종료 메서드 추론

사실 `@Bean` 은 `destroyMethod` 를 기본적으로 사용하고 있으며, 심지어는 명시적으로 메서드를 지정하지 않더라도 종료 메서드를 **추론하여** 호출해주고 있다.

- 실제 코드를 뒤져보면, 기본값이 `(inferred)` 라고 적혀있다.

라이브러리가 대부분 `close` 나 `shutdown` 이라는 이름의 종료 메서드를 사용하고 있기 때문에, 그걸 **종료 메서드로 간주하고 빈 소멸 시 자동으로 호출**해준다.

이걸 사용하기 싫으면 `destroyMethod = ""` 라고 해주면 된다.

---

## 애노테이션 @PostConstruct, @PreDestroy

빈 생명주기 콜백을 사용하는 **가장 이상적인 방법**

- `init` 메서드에 `@PostConstruct`를,

- `destory` 메서드에 `@PreDestroy` 를 달아준다.

### 애노테이션 특징

최신 스프링에서 가장 권장하는 방법.

일단 매우 편리하며, `@ComponentScan` 의 자동 빈 등록과도 잘 어울린다.

`javax` 에서 공식 지원하는 기능이기 때문에 **스프링에 종속적인 빈을 만들지 않을 수 있다**.

결정적인 약점은 코드 수정이 불가능한 **외부 라이브러리에** 사용이 불가능하다는 것.

- 이 경우에 한정하여 `@Bean` 의 기능을 사용하자.




