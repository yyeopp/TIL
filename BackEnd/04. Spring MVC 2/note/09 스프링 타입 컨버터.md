# 스프링 타입 컨버터

---

## 스프링 타입 컨버터

문자를 숫자로, 숫자를 문자로 등 클라이언트 요청에 대해 서버에서 **형변환**을 적용해야 하는 일은 굉장히 잦다.

**서블릿**을 있는 그대로 사용하는 경우 (`HttpServletRequest` 를 파라미터로 직접 받아서 사용하는 경우) 이러한 형 변환을 개발자가 직접 처리해야 한다.

- `request.getParameter()` 한 결과는 항상 String이다.

그나마 스프링을 적극적으로 사용하는 경우, `@RequestParam` 이나 `@PathVariable` 등에서 **다양한 자료형을 자동변환**하도록 지원해주기 때문에 개선된다.

- 내부 로직은 결국 `request.getParameter()` 이기 때문에 String으로 출발할 것이지만,

- 내부적으로 타입 변환이 적용되어 있어서 개발자가 신경쓰지 않게 된 것.

### 스프링의 타입 변환

#### 타입 변환 예시

- 스프링 MVC 요청 파라미터
  
  - `@RequestParam`
  
  - `@ModelAttribute`
  
  - `@PathVariable`

- `@Value` 등으로 프로퍼티 정보를 읽을 때

- XML에 등록한 스프링 빈 정보를 조회할 때

- 뷰를 렌더링 할 때

스프링은 수많은 케이스에서 타입 변환을 자동으로 처리해주고 있다.

정확히는 `Converter` 라는 인터페이스를 사용하여 이를 처리하며, 당연히 확장도 가능하다.

- 스프링에서 추가적인 타입 변환이 필요하면, 컨버터 인터페이스를 구현해서 등록하는 방식

#### 참고

과거에는 `PropertyEditor` 라는 클래스를 사용하여 타입변환을 처리했는데, 동시성 문제가 존재하여 `Converter`로 대체되었다.

---

## 타입 컨버터 - Converter

`Converter`라는 이름의 인터페이스가 매우 많으니 주의해서 사용하자.

- `Converter` 인터페이스를 직접 구현해본다. input과 output 형에 대해서는 제네릭으로 명시하고 사용하면 된다.

- 만드는 것 자체는 어렵지 않으나, 너무 단순하고 반복적인 느낌이 있다.

스프링은 **용도에 따라 다양한 방식**의 타입 컨버터를 제공하며,

- `Converter` : 기본 타입 컨버터

- `ConverterFactory` : 전체 클래스 계층 구조가 필요할 때

- `GenericConverter` : 정교한 구현, 대상 필드의 애노테이션 정보 사용 가능

- `ConditionalGenericConverter` : 특정 조건이 참인 경우

생각할 수 있는 **거의 모든 타입에 대한** 컨버터를 기본으로 제공하고 있다.

---

## 컨버전 서비스 - ConversionService

스프링은 개별 컨버터를 묶어두고 편리하게 사용할 수 있는 기능을 제공한다.

`ConversionService` 라는 인터페이스이며, 아래 두 가지 기능을 제공한다.

- **특정 컨버터를 사용할 수 있는지** (Boolean)

- **실제 컨버팅 처리** 

`DefaultConversionService` 라는 구현체를 사용해서, **컨버터를 등록**하고 실제로 사용한다.

### 등록과 사용 분리

`DefaultConversionService`는 **컨버터를 등록**하는 기능을 함께 가지고 있기 때문에 내가 원하는 컨버터를 직접 등록해서 사용할 수 있다.

이는 내부적으로 `ConverterRegistry` 인터페이스를 함께 구현해뒀기 때문에 가능한 일로,

한번 등록을 해두면 사용하는 입장에서는 **내부에 어떤 컨버터가 있는지 신경쓰지 않고** 사용할 수 있어 바람직하다.

### 인터페이스 분리 원칙 - ISP

더 나아가서 `DefaultConversionService` 는 ISP 관점에서도 바람직하다.

컨버팅 서비스가 필요한 클라이언트는 `ConversionService` 의 메서드에만 의존하면 되고, 컨버터 등록 및 관리에는 신경쓰지 않아도 된다.

애초에 두 인터페이스가 명확히 분리된 덕분에 가능했던 것.

### 정리

스프링은 내부적으로 `ConversionService`를 사용해서 타입을 변환한다.

- `@RequestParam` 같은 곳에서 모두 적용되어 있다.

---

## 스프링에 Converter 적용하기

`WebMvcConfigurer` 에 `addFormatter` 메서드를 사용해서, **컨버터를 직접 등록**할 수 있다.

물론 `StringToInteger` 를 포함한 대부분의 컨버터는 스프링이 기본적으로 등록하고 있기 때문에, 달리 등록해주지 않아도 알아서 작동한다.

- 거의 상상할 수 있는 모든 컨버팅 처리를 다 지원하고 있다.

### 처리 과정

`@RequestParam` 은 `ArgumentResolver` 중 하나인 `RequestParamMethodArgumentResolver`에 의해 처리되는데, 여기서 `ConversionService`를 사용해서 타입을 변환하고 있다.

---

## 뷰 템플릿에 컨버터 적용하기

타임리프는 스프링과 통합되어 있기 때문에, 파라미터를 바인딩할 때 타입컨버팅 처리를 지원하고 있다.

HTML 화면 상에서는 객체나 숫자가 **문자형**으로 변환될 필요가 있다.

---

## 포맷터 - Formatter

`Converter` 는 입력과 출력 타입에 제한이 없는 **범용 타입 변환** 기능을 제공한다.

- 정말 타입 간 변환이 **정직하게** 적용된다는 의미

- 1000을 "1000" 으로 변경한다든지

사실 일반적인 웹 애플리케이션에서는 그것보다도 **포맷팅**에 대한 니즈가 많은 편이다.

- 1000을 "1000" 으로 변환시키는 데 그치지 않고, "1,000" 으로 표시해주는 것

- 혹은 날짜에 대한 포맷팅 처리

- 날짜나 숫자의 표현에는 `Locale` 정보가 적용될 필요도 있다.

이렇게 객체를 **특정한 포맷에 맞춰 문자로 출력하거나 그 반대의 역할을 하는 것**이 `Formatter` 이다.

- 포맷터는 **컨버터의 일종으로** 보면 된다.

### 예제 코드 요약

- `Formatter` 인터페이스를 구현하여 포맷터를 직접 생성한다.
  
  - 제네릭을 통해 `parse` 대상 자료형을 넣어줘야 한다.

- 해당 인터페이스는 `parse` 와 `print` 두 가지 메서드를 구현해야 한다. 의도에 맞게 구현한다.

- 테스트코드에서 해당 포맷터를 이용해 input값에 대한 파싱처리와 output값에 대한 포맷팅 처리가 잘 이루어는지 확인한다.

---

## 포맷터를 지원하는 컨버전 서비스

애초에 포맷터도 컨버터의 일종이라는 점에서, 컨버전 서비스에서 포맷터를 추가할 수 있다.

내부에서 어댑터 패턴을 사용해서, `Formatter`가 `Converter`처럼 동작하도록 지원한다.

### 예제 코드 요약

- `DefaultFormattingConversionService` 를 이용해서, `convert` 메서드 하나로 타입 컨버팅 처리와 포맷팅 처리를 동시에 지원할 수 있다.

- 해당 구현체는 `ConversionService` 관련 기능과 포맷팅 기능을 함께 상속받고 있기 때문에 가능하다.

참고로 스프링부트의 경우, `DefaultFormattingConversionService` 를 상속받은 `WebConversionService`를 내부적으로 사용하고 있다.

### 포맷터 적용하기

마찬가지로 `WebConfig`에 해당 포맷터를 레지스트리로 등록할 수 있다.

- 단 등록 시 앞서 등록했던 타입 컨버터 일부를 지워줘야 하는데,

- `convert` 처리는 List에 등록된 클래스를 순차적으로 조회하면서 이루어지기 때문에 우선순위 이슈가 발생한다.

등록 후 실제 웹 서비스를 띄워서 확인하면, 다소 어렵다 싶은 포맷팅 처리가 이루어지는 것을 확인할 수 있다.

- 10,000 을 파라미터로 입력했을 때, 사용자의 Locale을 인지하여 이를 숫자 10000 으로 인식하는 

---

## 스프링이 제공하는 기본 포맷터

스프링은 자바에서 제공하는 타입들에 대해 수많은 포맷터를 기본으로 제공한다.

하지만 포맷터의 기본 형식이 지정되어 있기 때문에, 내가 만든 자료형의 각 필드마다 원하는 포맷을 지정하는 데에 다소 무리가 따른다.

스프링은 이를 해결하기 위해 **애노테이션 기반으로** 원하는 형식을 지정할 수 있는 포맷터 두 가지를 제공한다.

- `@NumberFormat` : 숫자형에 대한 포맷팅

- `@DateTimeFormat` : 날짜형에 대한 포맷팅

### 예제 코드 요약

- 직접 `Form` 클래스를 하나 만들면서, 그 필드에 `@NumberFormat` 과 `@DateTimeFormat` 을 적용한다.
  
  - `pattern = ` 이런 식으로 등록한다.

- 웹 서비스를 띄웠을 때, 해당 클래스를 사용한다면 입출력에 별다른 처리를 하지 않아도 포맷팅이 적용되는 것을 확인 가능하다.

### 정리

컨버터를 사용하든 포맷터를 사용하든, 사용 시에는 **컨버전 서비스**를 사용해서 일관성 있게 사용할 수 있다.

### 주의

**메시지컨버터** (`HttpMessageConverter`) 에는 컨버전 서비스가 **적용되지 않는다**.

- 메시지컨버터의 역할은 HTTP 메시지 **바디**의 내용을 다루는 것이다. 반면 컨버전 서비스는 그것보다는 파라미터나 Path, Model 쪽이다.

메시지컨버터는 객체를 JSON으로 변환하는 `RestController`에서 주로 사용되는데, 내부적으로 **Jackson** 같은 라이브러리를 사용하고 있기 때문에 **포맷팅 설정이 필요하다면 그 설정은 라이브러리에서 지원해줘야 한다**.

컨버전서비스는 `@RequestParam`, `@ModelAttribute`, `@PathVariable` 에서 사용하면 된다.


