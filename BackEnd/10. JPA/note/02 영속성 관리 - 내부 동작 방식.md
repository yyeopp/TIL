# 영속성 관리 - 내부 동작 방식

---

## 영속성 컨텍스트

### 영속성 컨텍스트란?

**엔티티를 영구 저장하는 환경**이라는 뜻

JPA를 이해하는 데 가장 중요한 용어

`EntityManager.persist(entity)`

- 영속성 컨텍스트는 **논리적**인 개념이다.

### 엔티티의 생명주기

- 비영속 (new / transient)
  
  - 영속성 컨텍스트와 전혀 관계 없음

- 영속 (managed)
  
  - 영속성 컨텍스트에서 관리되는 상태
  
  - `em.persist()` 하는 순간 **영속** 상태가 된다.
  
  - 근데 이게 **DB에 저장됐다**는 뜻이 **아니다**.
  
  - 영속성 컨텍스트 내에서 관리하다가, `tx.commit()`하는 순간에 비로소 DB에 저장된다.

- 준영속 (detached)
  
  - 영속성 컨텍스트에 저장되었다가 분리된 상태

- 삭제 (removed)
  
  - 삭제된 상태

### 엔티티 조회, 1차 캐시

영속성 컨텍스트는 일반적으로 하나의 트랜잭션 내에서 유지된다.

트랜잭션 내에서 영속성 컨텍스트가 가지고 있는 데이터를 조회하고자 시도할 시,

영속성 컨텍스트에 저장된 데이터가 **1차 캐시**로써 작동하여 DB에 접근하지 않게 된다.

### 영속 엔티티의 동일성 보장

마치 Java Collection에서 객체를 조회한 것처럼, 1차 캐시에서 가져오는 영속 엔티티 간의 동일성 (메모리 주소) 을 보장한다.

**REPEATABLE READ**등급의 트랜잭션 격리 수준을 애플리케이션 차원에서 제공하게 된다.

### 트랜잭션을 지원하는 쓰기 지연

`em.persist()` 가 아니라 `tx.commit()` 하는 순간에 insert SQL이 DB로 보내진다.

정확히, `em.persist()` 하는 순간

- JPA 내부의 **쓰기 지연 SQL 저장소**에 insert 쿼리를 저장하고

- 영속성 컨텍스트 **1차 캐시**에 데이터를 저장한다.


